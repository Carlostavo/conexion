<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Análisis de Comportamiento Proambiental - Cantón Daule</title>

  <!-- Supabase (CDN) -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <!-- Chart.js con plugins avanzados -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>
  <!-- Iconos -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <!-- Google Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

  <style>
    :root {
      --primary: #0f766e;
      --primary-light: #14b8a6;
      --primary-dark: #0d5d57;
      --secondary: #2d4cc8;
      --accent: #7c3aed;
      --bg1: #f8fafc;
      --bg2: #f0fdfa;
      --card: #ffffff;
      --muted: #64748b;
      --success: #10b981;
      --warning: #f59e0b;
      --danger: #ef4444;
      --border: #e2e8f0;
      --shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.05), 0 4px 6px -2px rgba(0, 0, 0, 0.025);
      --radius: 12px;
      --header-height: 80px;
    }
    
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    
    body {
      font-family: 'Inter', 'Segoe UI', Roboto, Arial, sans-serif;
      background: linear-gradient(135deg, var(--bg1), var(--bg2));
      color: #1e293b;
      line-height: 1.6;
      min-height: 100vh;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }
    
    header {
      background: linear-gradient(135deg, var(--primary), var(--primary-dark));
      color: white;
      padding: 0 20px;
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
      position: sticky;
      top: 0;
      z-index: 100;
    }
    
    .header-content {
      max-width: 1400px;
      margin: 0 auto;
      display: flex;
      align-items: center;
      justify-content: space-between;
      height: var(--header-height);
    }
    
    .logo {
      display: flex;
      align-items: center;
      gap: 12px;
    }
    
    .logo i {
      font-size: 32px;
    }
    
    .logo-text {
      display: flex;
      flex-direction: column;
    }
    
    h1 {
      font-size: 22px;
      font-weight: 700;
      margin: 0;
      line-height: 1.2;
    }
    
    .subtitle {
      opacity: 0.9;
      font-size: 14px;
      margin-top: 2px;
      font-weight: 400;
    }
    
    .header-actions {
      display: flex;
      gap: 12px;
    }
    
    main {
      max-width: 1400px;
      margin: 32px auto;
      padding: 0 20px;
    }
    
    .card {
      background: var(--card);
      border-radius: var(--radius);
      padding: 24px;
      box-shadow: var(--shadow);
      margin-bottom: 24px;
      border: 1px solid var(--border);
      transition: transform 0.2s, box-shadow 0.2s;
    }
    
    .card:hover {
      transform: translateY(-2px);
      box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
    }
    
    .card-title {
      color: var(--primary);
      font-size: 18px;
      font-weight: 600;
      margin-bottom: 16px;
      display: flex;
      align-items: center;
      gap: 8px;
      border-bottom: 1px solid var(--border);
      padding-bottom: 12px;
    }
    
    .controls {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 16px;
      margin-bottom: 20px;
    }
    
    .control-group {
      display: flex;
      flex-direction: column;
    }
    
    .control-group label {
      font-size: 14px;
      font-weight: 500;
      margin-bottom: 6px;
      color: var(--muted);
      display: flex;
      align-items: center;
      gap: 6px;
    }
    
    .filter-info {
      font-size: 11px;
      color: var(--muted);
      margin-top: 4px;
      font-style: italic;
    }
    
    select {
      padding: 12px 14px;
      border-radius: 8px;
      border: 1px solid var(--border);
      background: white;
      font-family: inherit;
      font-size: 14px;
      transition: all 0.2s;
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke='%230f766e'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M19 9l-7 7-7-7'%3E%3C/path%3E%3C/svg%3E");
      background-repeat: no-repeat;
      background-position: right 12px center;
      background-size: 16px;
      appearance: none;
      padding-right: 40px;
    }
    
    select:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(15, 118, 110, 0.1);
    }
    
    button {
      background: var(--primary);
      color: white;
      border: none;
      cursor: pointer;
      font-weight: 500;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      transition: all 0.2s;
      padding: 12px 18px;
      border-radius: 8px;
      font-size: 14px;
    }
    
    button:hover {
      background: var(--primary-dark);
      transform: translateY(-1px);
    }
    
    button.secondary {
      background: white;
      color: var(--primary);
      border: 1px solid var(--primary);
    }
    
    button.secondary:hover {
      background: var(--bg1);
    }
    
    .action-buttons {
      display: flex;
      gap: 8px;
      margin-top: 16px;
    }
    
    .summary-cards {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 16px;
      margin-bottom: 24px;
    }
    
    .summary-card {
      background: linear-gradient(135deg, #fff, #f7fffb);
      padding: 20px;
      border-radius: 10px;
      border: 1px solid #eef7f4;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
      transition: transform 0.2s;
      display: flex;
      flex-direction: column;
    }
    
    .summary-card:hover {
      transform: translateY(-2px);
    }
    
    .summary-title {
      font-size: 13px;
      color: var(--muted);
      margin-bottom: 8px;
      display: flex;
      align-items: center;
      gap: 6px;
      font-weight: 500;
    }
    
    .summary-value {
      font-size: 28px;
      font-weight: 700;
      color: var(--primary);
      margin-bottom: 4px;
    }
    
    .summary-subtitle {
      font-size: 12px;
      display: flex;
      align-items: center;
      gap: 4px;
    }
    
    .positive {
      color: var(--success);
    }
    
    .negative {
      color: var(--danger);
    }
    
    .chart-container {
      position: relative;
      height: 500px;
      margin-top: 20px;
    }
    
    .chart-container-sm {
      position: relative;
      height: 350px;
      margin-top: 20px;
    }
    
    .tabs {
      display: flex;
      border-bottom: 1px solid var(--border);
      margin-bottom: 16px;
      flex-wrap: wrap;
    }
    
    .tab {
      padding: 12px 20px;
      cursor: pointer;
      font-weight: 500;
      color: var(--muted);
      border-bottom: 2px solid transparent;
      transition: all 0.2s;
    }
    
    .tab.active {
      color: var(--primary);
      border-bottom: 2px solid var(--primary);
    }
    
    .tab-content {
      display: none;
    }
    
    .tab-content.active {
      display: block;
    }
    
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 12px;
    }
    
    th, td {
      padding: 14px 12px;
      text-align: left;
      border-bottom: 1px solid var(--border);
    }
    
    th {
      font-weight: 600;
      color: var(--muted);
      font-size: 14px;
      background-color: #f8fafc;
    }
    
    tr:hover {
      background-color: #f8fafc;
    }
    
    .total-row {
      background-color: #f0f9ff;
      font-weight: 600;
    }
    
    .total-row td {
      border-top: 2px solid var(--primary);
    }
    
    .statistics-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 16px;
      margin-top: 20px;
    }
    
    .stat-card {
      background: white;
      border-radius: 10px;
      padding: 20px;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
      border: 1px solid var(--border);
      transition: transform 0.2s;
    }
    
    .stat-card:hover {
      transform: translateY(-2px);
    }
    
    .stat-card h4 {
      font-size: 14px;
      color: var(--muted);
      margin-bottom: 8px;
      font-weight: 500;
    }
    
    .stat-value {
      font-size: 20px;
      font-weight: 600;
      color: var(--primary);
    }
    
    .stats-section {
      margin-top: 24px;
    }
    
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 16px;
      margin-top: 16px;
    }
    
    .stat-item {
      background: #f8fafc;
      border-radius: 8px;
      padding: 16px;
      display: flex;
      flex-direction: column;
      transition: transform 0.2s;
    }
    
    .stat-item:hover {
      transform: translateY(-2px);
    }
    
    .stat-label {
      font-size: 12px;
      color: var(--muted);
      margin-bottom: 6px;
      font-weight: 500;
    }
    
    .stat-number {
      font-size: 20px;
      font-weight: 600;
      color: var(--primary);
    }
    
    footer {
      text-align: center;
      color: var(--muted);
      font-size: 13px;
      margin: 24px 0;
      padding: 16px;
      border-top: 1px solid var(--border);
    }
    
    .loading {
      display: flex;
      justify-content: center;
      align-items: center;
      height: 200px;
      flex-direction: column;
      gap: 12px;
    }
    
    .spinner {
      width: 40px;
      height: 40px;
      border: 4px solid rgba(15, 118, 110, 0.2);
      border-left: 4px solid var(--primary);
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    .export-options {
      display: none;
      position: absolute;
      right: 0;
      top: 40px;
      background: white;
      border-radius: 8px;
      box-shadow: var(--shadow);
      padding: 8px;
      z-index: 10;
      min-width: 150px;
    }
    
    .export-options.show {
      display: block;
    }
    
    .export-option {
      padding: 8px 12px;
      cursor: pointer;
      border-radius: 4px;
      font-size: 14px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .export-option:hover {
      background: var(--bg1);
    }
    
    .chart-type-selector {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-bottom: 16px;
      align-items: center;
    }
    
    .chart-type-btn {
      background: white;
      border: 1px solid var(--border);
      color: var(--muted);
      padding: 8px 12px;
      border-radius: 6px;
      cursor: pointer;
      transition: all 0.2s;
      font-size: 13px;
      display: flex;
      align-items: center;
      gap: 6px;
    }
    
    .chart-type-btn.active {
      background: var(--primary);
      color: white;
      border-color: var(--primary);
    }
    
    .chart-type-btn:hover:not(.active) {
      background: var(--bg1);
      border-color: var(--primary-light);
    }
    
    .charts-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
      gap: 24px;
      margin-top: 20px;
    }
    
    .chart-card {
      background: white;
      border-radius: 10px;
      padding: 20px;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
      border: 1px solid var(--border);
    }
    
    .chart-card h3 {
      color: var(--primary);
      margin-bottom: 16px;
      font-size: 16px;
      font-weight: 600;
    }
    
    .category-section {
      margin-bottom: 32px;
    }
    
    .category-title {
      color: var(--primary);
      font-size: 18px;
      font-weight: 600;
      margin-bottom: 16px;
      padding-bottom: 8px;
      border-bottom: 1px solid var(--border);
    }
    
    .table-responsive {
      overflow-x: auto;
    }
    
    /* Estilos específicos para gráficos de preguntas */
    .question-charts {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(600px, 1fr));
      gap: 24px;
      margin-top: 20px;
    }
    
    .question-chart-container {
      position: relative;
      height: 400px;
      margin-top: 20px;
    }
    
    .question-chart-card {
      background: white;
      border-radius: 10px;
      padding: 20px;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
      border: 1px solid var(--border);
    }
    
    .question-chart-card h3 {
      color: var(--primary);
      margin-bottom: 16px;
      font-size: 16px;
      font-weight: 600;
      line-height: 1.4;
    }
    
    /* Estilos para mejoras en gráficos */
    .chart-actions {
      display: flex;
      justify-content: flex-end;
      gap: 8px;
      margin-bottom: 16px;
    }
    
    .chart-action-btn {
      padding: 6px 12px;
      border-radius: 6px;
      background: white;
      border: 1px solid var(--border);
      font-size: 12px;
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      gap: 4px;
    }
    
    .chart-action-btn:hover {
      background: var(--bg1);
      border-color: var(--primary-light);
    }
    
    .chart-action-btn.active {
      background: var(--primary);
      color: white;
      border-color: var(--primary);
    }
    
    /* Mejoras para gráficos más nítidos */
    canvas {
      image-rendering: -webkit-optimize-contrast;
      image-rendering: crisp-edges;
      image-rendering: pixelated;
    }
    
    .chartjs-render-monitor {
      -webkit-filter: none !important;
      filter: none !important;
    }
    
    @media (max-width: 768px) {
      .header-content {
        flex-direction: column;
        gap: 12px;
        height: auto;
        padding: 16px 0;
      }
      
      .controls {
        grid-template-columns: 1fr;
      }
      
      .action-buttons {
        justify-content: center;
      }
      
      .chart-container {
        height: 400px;
      }
      
      .summary-cards {
        grid-template-columns: 1fr;
      }
      
      .chart-type-selector {
        justify-content: center;
      }
      
      .charts-grid {
        grid-template-columns: 1fr;
      }
      
      .question-charts {
        grid-template-columns: 1fr;
      }
      
      .question-chart-container {
        height: 350px;
      }
      
      .chart-actions {
        justify-content: center;
      }
    }
  </style>
</head>
<body>
  <header>
    <div class="header-content">
      <div class="logo">
        <i class="fas fa-leaf"></i>
        <div class="logo-text">
          <h1>Análisis de Comportamiento Proambiental</h1>
          <div class="subtitle">Cantón Daule - Panel de Indicadores</div>
        </div>
      </div>
      <div class="header-actions">
        <button id="btnHelp" class="secondary" title="Ayuda">
          <i class="fas fa-question-circle"></i> Ayuda
        </button>
      </div>
    </div>
  </header>

  <main>
    <!-- Panel de control principal -->
    <div class="card">
      <div class="card-title">
        <i class="fas fa-sliders-h"></i>
        Filtros de Análisis
      </div>
      
      <!-- Controles -->
      <div class="controls" id="controls">
        <div class="control-group">
          <label for="selectEstadoCivil"><i class="fas fa-heart"></i> Estado Civil</label>
          <select id="selectEstadoCivil">
            <option value="">Todos los estados civiles</option>
          </select>
          <div class="filter-info" id="estadoCivilInfo">Cargando...</div>
        </div>

        <div class="control-group">
          <label for="selectEducacion"><i class="fas fa-graduation-cap"></i> Nivel de Educación</label>
          <select id="selectEducacion">
            <option value="">Todos los niveles</option>
          </select>
          <div class="filter-info" id="educacionInfo">Cargando...</div>
        </div>

        <div class="control-group">
          <label for="selectSituacionLaboral"><i class="fas fa-briefcase"></i> Situación Laboral</label>
          <select id="selectSituacionLaboral">
            <option value="">Todas las situaciones</option>
          </select>
          <div class="filter-info" id="situacionLaboralInfo">Cargando...</div>
        </div>

        <div class="control-group">
          <label for="selectIngreso"><i class="fas fa-money-bill-wave"></i> Ingreso Mensual</label>
          <select id="selectIngreso">
            <option value="">Todos los ingresos</option>
          </select>
          <div class="filter-info" id="ingresoInfo">Cargando...</div>
        </div>
      </div>
    </div>

    <!-- Tarjetas de resumen -->
    <div class="card">
      <div class="card-title">
        <i class="fas fa-chart-line"></i>
        Resumen General
      </div>
      
      <div class="summary-cards" id="summaryCards">
        <div class="summary-card">
          <div class="summary-title">
            <i class="fas fa-users"></i> Total de Encuestados
          </div>
          <div class="summary-value" id="summaryTotal">0</div>
          <div class="summary-subtitle">
            <span>Muestra representativa del cantón</span>
          </div>
        </div>
        <div class="summary-card">
          <div class="summary-title">
            <i class="fas fa-home"></i> Tipo de Hogar Predominante
          </div>
          <div class="summary-value" id="summaryHogar">-</div>
          <div class="summary-subtitle" id="summaryHogarChange">
            <span>% del total</span>
          </div>
        </div>
        <div class="summary-card">
          <div class="summary-title">
            <i class="fas fa-user-graduate"></i> Educación Predominante
          </div>
          <div class="summary-value" id="summaryEducacion">-</div>
          <div class="summary-subtitle" id="summaryEducacionChange">
            <span>% del total</span>
          </div>
        </div>
        <div class="summary-card">
          <div class="summary-title">
            <i class="fas fa-briefcase"></i> Situación Laboral Predominante
          </div>
          <div class="summary-value" id="summaryLaboral">-</div>
          <div class="summary-subtitle" id="summaryLaboralChange">
            <span>% del total</span>
          </div>
        </div>
      </div>
    </div>

    <!-- Gráficos y visualizaciones -->
    <div class="card">
      <div class="card-title">
        <i class="fas fa-chart-bar"></i>
        Visualización de Datos
      </div>
      
      <div class="chart-actions">
        <div class="chart-action-btn" data-chart-type="bar">
          <i class="fas fa-chart-bar"></i> Barras
        </div>
        <div class="chart-action-btn active" data-chart-type="pie">
          <i class="fas fa-chart-pie"></i> Torta
        </div>
        <div class="chart-action-btn" data-chart-type="line">
          <i class="fas fa-chart-line"></i> Líneas
        </div>
      </div>
      
      <div class="tabs">
        <div class="tab active" data-tab="demographics">Distribución Demográfica</div>
        <div class="tab" data-tab="sociocultural">Determinantes Socioculturales</div>
        <div class="tab" data-tab="afectivos">Determinantes Afectivos</div>
        <div class="tab" data-tab="cognitivos">Determinantes Cognitivos</div>
        <div class="tab" data-tab="ambiental">Sustentabilidad Ambiental</div>
        <div class="tab" data-tab="economica">Sustentabilidad Económica</div>
        <div class="tab" data-tab="comunitario">Desarrollo Comunitario</div>
      </div>
      
      <div class="tab-content active" id="demographics">
        <div class="charts-grid">
          <div class="chart-card">
            <h3>Distribución por Estado Civil</h3>
            <div class="chart-container-sm">
              <canvas id="estadoCivilChart"></canvas>
            </div>
          </div>
          <div class="chart-card">
            <h3>Distribución por Nivel Educativo</h3>
            <div class="chart-container-sm">
              <canvas id="educacionChart"></canvas>
            </div>
          </div>
          <div class="chart-card">
            <h3>Distribución por Situación Laboral</h3>
            <div class="chart-container-sm">
              <canvas id="laboralChart"></canvas>
            </div>
          </div>
          <div class="chart-card">
            <h3>Distribución por Ingreso Mensual</h3>
            <div class="chart-container-sm">
              <canvas id="ingresoChart"></canvas>
            </div>
          </div>
          <div class="chart-card">
            <h3>Distribución por Tipo de Hogar</h3>
            <div class="chart-container-sm">
              <canvas id="hogarChart"></canvas>
            </div>
          </div>
          <div class="chart-card">
            <h3>Distribución por Grupos de Edad</h3>
            <div class="chart-container-sm">
              <canvas id="edadChart"></canvas>
            </div>
          </div>
        </div>
      </div>
      
      <!-- Determinantes Socioculturales -->
      <div class="tab-content" id="sociocultural">
        <div class="question-charts">
          <div class="question-chart-card">
            <h3>¿Conoce usted qué son los desechos sólidos domiciliarios?</h3>
            <div class="question-chart-container">
              <canvas id="socioculturalChart1"></canvas>
            </div>
          </div>
          <div class="question-chart-card">
            <h3>¿Cree usted que existe un comportamiento adecuado en el manejo de los desechos sólidos domiciliarios en la comunidad?</h3>
            <div class="question-chart-container">
              <canvas id="socioculturalChart2"></canvas>
            </div>
          </div>
          <div class="question-chart-card">
            <h3>¿Se debe separar los desechos sólidos según su tipo ejemplo: (papel - plástico - orgánico - inorgánico)?</h3>
            <div class="question-chart-container">
              <canvas id="socioculturalChart3"></canvas>
            </div>
          </div>
          <div class="question-chart-card">
            <h3>¿Es importante la correcta clasificación de los desechos sólidos orgánicos e inorgánicos en el hogar?</h3>
            <div class="question-chart-container">
              <canvas id="socioculturalChart4"></canvas>
            </div>
          </div>
          <div class="question-chart-card">
            <h3>¿Cree que el comportamiento de la comunidad influye en deterioro del medio ambiente?</h3>
            <div class="question-chart-container">
              <canvas id="socioculturalChart5"></canvas>
            </div>
          </div>
          <div class="question-chart-card">
            <h3>¿Dedica tiempo para reducir, reutilizar y/o reciclar los desechos sólidos que se generan en el hogar?</h3>
            <div class="question-chart-container">
              <canvas id="socioculturalChart6"></canvas>
            </div>
          </div>
          <div class="question-chart-card">
            <h3>¿Los desechos sólidos son un gran problema para la comunidad?</h3>
            <div class="question-chart-container">
              <canvas id="socioculturalChart7"></canvas>
            </div>
          </div>
        </div>
      </div>
      
      <!-- Determinantes Afectivos -->
      <div class="tab-content" id="afectivos">
        <div class="question-charts">
          <div class="question-chart-card">
            <h3>¿Le preocupa el exceso de desechos sólidos domiciliarios?</h3>
            <div class="question-chart-container">
              <canvas id="afectivosChart1"></canvas>
            </div>
          </div>
          <div class="question-chart-card">
            <h3>¿Considera que los desechos sólidos domiciliarios intervienen en las consecuencias climáticas?</h3>
            <div class="question-chart-container">
              <canvas id="afectivosChart2"></canvas>
            </div>
          </div>
          <div class="question-chart-card">
            <h3>¿Le afecta emocionalmente cuando escucha noticias acerca de los desastres naturales?</h3>
            <div class="question-chart-container">
              <canvas id="afectivosChart3"></canvas>
            </div>
          </div>
          <div class="question-chart-card">
            <h3>¿Siente frustración debido a la falta de acciones significativas para abordar la generación de los desechos sólidos?</h3>
            <div class="question-chart-container">
              <canvas id="afectivosChart4"></canvas>
            </div>
          </div>
          <div class="question-chart-card">
            <h3>¿Considera importante pensar en el tipo de planeta que dejaremos a las futuras generaciones?</h3>
            <div class="question-chart-container">
              <canvas id="afectivosChart5"></canvas>
            </div>
          </div>
        </div>
      </div>
      
      <!-- Determinantes Cognitivos -->
      <div class="tab-content" id="cognitivos">
        <div class="question-charts">
          <div class="question-chart-card">
            <h3>¿Es consciente del impacto de los desechos sólidos domiciliarios en el medio ambiente?</h3>
            <div class="question-chart-container">
              <canvas id="cognitivosChart1"></canvas>
            </div>
          </div>
          <div class="question-chart-card">
            <h3>¿Investiga frecuentemente acerca de temas medio ambientales?</h3>
            <div class="question-chart-container">
              <canvas id="cognitivosChart2"></canvas>
            </div>
          </div>
          <div class="question-chart-card">
            <h3>¿Conoce las consecuencias de la acumulación de los desechos sólidos domiciliarios?</h3>
            <div class="question-chart-container">
              <canvas id="cognitivosChart3"></canvas>
            </div>
          </div>
          <div class="question-chart-card">
            <h3>¿Conoce los beneficios de reutilizar un residuo domiciliario?</h3>
            <div class="question-chart-container">
              <canvas id="cognitivosChart4"></canvas>
            </div>
          </div>
          <div class="question-chart-card">
            <h3>¿La falta de información es un obstáculo para la correcta gestión de los residuos sólidos domiciliario?</h3>
            <div class="question-chart-container">
              <canvas id="cognitivosChart5"></canvas>
            </div>
          </div>
        </div>
      </div>
      
      <!-- Sustentabilidad Ambiental -->
      <div class="tab-content" id="ambiental">
        <div class="question-charts">
          <div class="question-chart-card">
            <h3>¿Los desechos orgánicos generados en el hogar pueden tener otra funcionalidad?</h3>
            <div class="question-chart-container">
              <canvas id="ambientalChart1"></canvas>
            </div>
          </div>
          <div class="question-chart-card">
            <h3>¿La acumulación de desechos afectan a la salud de la población?</h3>
            <div class="question-chart-container">
              <canvas id="ambientalChart2"></canvas>
            </div>
          </div>
          <div class="question-chart-card">
            <h3>¿La reducción, reciclaje y la reutilización de los desechos sólidos puede cuidar al medio ambiente y a la vida silvestre?</h3>
            <div class="question-chart-container">
              <canvas id="ambientalChart3"></canvas>
            </div>
          </div>
          <div class="question-chart-card">
            <h3>¿Cree que la transformación de desechos sólidos en nuevos productos puede contribuir significativamente a la reducción de la generación de desechos?</h3>
            <div class="question-chart-container">
              <canvas id="ambientalChart4"></canvas>
            </div>
          </div>
          <div class="question-chart-card">
            <h3>¿Necesita más información acerca de educación ambiental?</h3>
            <div class="question-chart-container">
              <canvas id="ambientalChart5"></canvas>
            </div>
          </div>
        </div>
      </div>
      
      <!-- Sustentabilidad Económica -->
      <div class="tab-content" id="economica">
        <div class="question-charts">
          <div class="question-chart-card">
            <h3>¿En su hogar practica la separación de los desechos para el reciclaje y le representa algún ingreso?</h3>
            <div class="question-chart-container">
              <canvas id="economicaChart1"></canvas>
            </div>
          </div>
          <div class="question-chart-card">
            <h3>¿Los desechos sólidos generados en el hogar pueden ser reutilizados para una nueva función o creación de un producto?</h3>
            <div class="question-chart-container">
              <canvas id="economicaChart2"></canvas>
            </div>
          </div>
          <div class="question-chart-card">
            <h3>¿Cree que el manejo adecuado de los desechos sólidos domiciliarios podría aportar al desarrollo económico comunitario?</h3>
            <div class="question-chart-container">
              <canvas id="economicaChart3"></canvas>
            </div>
          </div>
          <div class="question-chart-card">
            <h3>¿Los emprendimientos en base a la reutilización de los desechos aporta a su economía?</h3>
            <div class="question-chart-container">
              <canvas id="economicaChart4"></canvas>
            </div>
          </div>
          <div class="question-chart-card">
            <h3>¿El manejo adecuado de los desechos sólidos domiciliarios ofrece oportunidades para el emprendimiento?</h3>
            <div class="question-chart-container">
              <canvas id="economicaChart5"></canvas>
            </div>
          </div>
        </div>
      </div>
      
      <!-- Desarrollo Comunitario -->
      <div class="tab-content" id="comunitario">
        <div class="question-charts">
          <div class="question-chart-card">
            <h3>¿Es posible reducir la generación de residuos sólidos domiciliarios por medio de eventos de concientización?</h3>
            <div class="question-chart-container">
              <canvas id="comunitarioChart1"></canvas>
            </div>
          </div>
          <div class="question-chart-card">
            <h3>¿Participaría en talleres de buenas prácticas y capacitaciones para el correcto manejo de los desechos sólidos domiciliarios?</h3>
            <div class="question-chart-container">
              <canvas id="comunitarioChart2"></canvas>
            </div>
          </div>
          <div class="question-chart-card">
            <h3>¿El manejo adecuado de los desechos sólidos domiciliarios puede tener un impacto significativo al medio ambiente?</h3>
            <div class="question-chart-container">
              <canvas id="comunitarioChart3"></canvas>
            </div>
          </div>
          <div class="question-chart-card">
            <h3>¿Está dispuesto a participar en un emprendimiento en base al uso de los desechos sólidos?</h3>
            <div class="question-chart-container">
              <canvas id="comunitarioChart4"></canvas>
            </div>
          </div>
          <div class="question-chart-card">
            <h3>¿Participaría a una feria de emprendimientos comunitarios en base a desechos domiciliarios reutilizados?</h3>
            <div class="question-chart-container">
              <canvas id="comunitarioChart5"></canvas>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Tablas Resumen -->
    <div class="card">
      <div class="card-title">
        <i class="fas fa-table"></i>
        Tablas Resumen por Categorías
      </div>
      
      <div class="tabs">
        <div class="tab active" data-tab="tabla-demografica">Datos Demográficos</div>
        <div class="tab" data-tab="tabla-sociocultural">Determinantes Socioculturales</div>
        <div class="tab" data-tab="tabla-afectivos">Determinantes Afectivos</div>
        <div class="tab" data-tab="tabla-cognitivos">Determinantes Cognitivos</div>
        <div class="tab" data-tab="tabla-ambiental">Sustentabilidad Ambiental</div>
        <div class="tab" data-tab="tabla-economica">Sustentabilidad Económica</div>
        <div class="tab" data-tab="tabla-comunitario">Desarrollo Comunitario</div>
      </div>
      
      <div class="tab-content active" id="tabla-demografica">
        <div class="category-section">
          <div class="category-title">Estado Civil</div>
          <div class="table-responsive">
            <table>
              <thead>
                <tr>
                  <th>Estado Civil</th>
                  <th style="text-align:right">Cantidad</th>
                  <th style="text-align:right">% del Total</th>
                </tr>
              </thead>
              <tbody id="tablaEstadoCivil"></tbody>
              <tfoot>
                <tr class="total-row">
                  <td><strong>Total</strong></td>
                  <td style="text-align:right"><strong id="totalEstadoCivil">0</strong></td>
                  <td style="text-align:right"><strong>100%</strong></td>
                </tr>
              </tfoot>
            </table>
          </div>
        </div>
        
        <div class="category-section">
          <div class="category-title">Distribución por Edades</div>
          <div class="table-responsive">
            <table>
              <thead>
                <tr>
                  <th>Grupo de Edad</th>
                  <th style="text-align:right">Cantidad</th>
                  <th style="text-align:right">% del Total</th>
                </tr>
              </thead>
              <tbody id="tablaEdades"></tbody>
              <tfoot>
                <tr class="total-row">
                  <td><strong>Total</strong></td>
                  <td style="text-align:right"><strong id="totalEdades">0</strong></td>
                  <td style="text-align:right"><strong>100%</strong></td>
                </tr>
              </tfoot>
            </table>
          </div>
        </div>
        
        <div class="category-section">
          <div class="category-title">Nivel de Educación</div>
          <div class="table-responsive">
            <table>
              <thead>
                <tr>
                  <th>Nivel Educativo</th>
                  <th style="text-align:right">Cantidad</th>
                  <th style="text-align:right">% del Total</th>
                </tr>
              </thead>
              <tbody id="tablaEducacion"></tbody>
              <tfoot>
                <tr class="total-row">
                  <td><strong>Total</strong></td>
                  <td style="text-align:right"><strong id="totalEducacion">0</strong></td>
                  <td style="text-align:right"><strong>100%</strong></td>
                </tr>
              </tfoot>
            </table>
          </div>
        </div>
        
        <div class="category-section">
          <div class="category-title">Situación Laboral</div>
          <div class="table-responsive">
            <table>
              <thead>
                <tr>
                  <th>Situación Laboral</th>
                  <th style="text-align:right">Cantidad</th>
                  <th style="text-align:right">% del Total</th>
                </tr>
              </thead>
              <tbody id="tablaLaboral"></tbody>
              <tfoot>
                <tr class="total-row">
                  <td><strong>Total</strong></td>
                  <td style="text-align:right"><strong id="totalLaboral">0</strong></td>
                  <td style="text-align:right"><strong>100%</strong></td>
                </tr>
              </tfoot>
            </table>
          </div>
        </div>
        
        <div class="category-section">
          <div class="category-title">Ingreso Mensual</div>
          <div class="table-responsive">
            <table>
              <thead>
                <tr>
                  <th>Nivel de Ingreso</th>
                  <th style="text-align:right">Cantidad</th>
                  <th style="text-align:right">% del Total</th>
                </tr>
              </thead>
              <tbody id="tablaIngreso"></tbody>
              <tfoot>
                <tr class="total-row">
                  <td><strong>Total</strong></td>
                  <td style="text-align:right"><strong id="totalIngreso">0</strong></td>
                  <td style="text-align:right"><strong>100%</strong></td>
                </tr>
              </tfoot>
            </table>
          </div>
        </div>
        
        <div class="category-section">
          <div class="category-title">Tipo de Hogar</div>
          <div class="table-responsive">
            <table>
              <thead>
                <tr>
                  <th>Tipo de Hogar</th>
                  <th style="text-align:right">Cantidad</th>
                  <th style="text-align:right">% del Total</th>
                </tr>
              </thead>
              <tbody id="tablaHogar"></tbody>
              <tfoot>
                <tr class="total-row">
                  <td><strong>Total</strong></td>
                  <td style="text-align:right"><strong id="totalHogar">0</strong></td>
                  <td style="text-align:right"><strong>100%</strong></td>
                </tr>
              </tfoot>
            </table>
          </div>
        </div>
      </div>
      
      <div class="tab-content" id="tabla-sociocultural">
        <div class="category-section">
          <div class="category-title">Determinantes Socioculturales</div>
          <div class="table-responsive">
            <table>
              <thead>
                <tr>
                  <th>Pregunta</th>
                  <th style="text-align:center">Totalmente Desacuerdo</th>
                  <th style="text-align:center">Desacuerdo</th>
                  <th style="text-align:center">Indiferente</th>
                  <th style="text-align:center">De Acuerdo</th>
                  <th style="text-align:center">Totalmente Acuerdo</th>
                  <th style="text-align:center">Promedio</th>
                </tr>
              </thead>
              <tbody id="tablaSociocultural"></tbody>
              <tfoot>
                <tr class="total-row">
                  <td><strong>Promedio General</strong></td>
                  <td style="text-align:center"><strong id="promedioSocioculturalTD">0%</strong></td>
                  <td style="text-align:center"><strong id="promedioSocioculturalD">0%</strong></td>
                  <td style="text-align:center"><strong id="promedioSocioculturalI">0%</strong></td>
                  <td style="text-align:center"><strong id="promedioSocioculturalA">0%</strong></td>
                  <td style="text-align:center"><strong id="promedioSocioculturalTA">0%</strong></td>
                  <td style="text-align:center"><strong id="promedioSociocultural">0%</strong></td>
                </tr>
              </tfoot>
            </table>
          </div>
        </div>
      </div>
      
      <div class="tab-content" id="tabla-afectivos">
        <div class="category-section">
          <div class="category-title">Determinantes Afectivos</div>
          <div class="table-responsive">
            <table>
              <thead>
                <tr>
                  <th>Pregunta</th>
                  <th style="text-align:center">Totalmente Desacuerdo</th>
                  <th style="text-align:center">Desacuerdo</th>
                  <th style="text-align:center">Indiferente</th>
                  <th style="text-align:center">De Acuerdo</th>
                  <th style="text-align:center">Totalmente Acuerdo</th>
                  <th style="text-align:center">Promedio</th>
                </tr>
              </thead>
              <tbody id="tablaAfectivos"></tbody>
              <tfoot>
                <tr class="total-row">
                  <td><strong>Promedio General</strong></td>
                  <td style="text-align:center"><strong id="promedioAfectivosTD">0%</strong></td>
                  <td style="text-align:center"><strong id="promedioAfectivosD">0%</strong></td>
                  <td style="text-align:center"><strong id="promedioAfectivosI">0%</strong></td>
                  <td style="text-align:center"><strong id="promedioAfectivosA">0%</strong></td>
                  <td style="text-align:center"><strong id="promedioAfectivosTA">0%</strong></td>
                  <td style="text-align:center"><strong id="promedioAfectivos">0%</strong></td>
                </tr>
              </tfoot>
            </table>
          </div>
        </div>
      </div>
      
      <div class="tab-content" id="tabla-cognitivos">
        <div class="category-section">
          <div class="category-title">Determinantes Cognitivos</div>
          <div class="table-responsive">
            <table>
              <thead>
                <tr>
                  <th>Pregunta</th>
                  <th style="text-align:center">Totalmente Desacuerdo</th>
                  <th style="text-align:center">Desacuerdo</th>
                  <th style="text-align:center">Indiferente</th>
                  <th style="text-align:center">De Acuerdo</th>
                  <th style="text-align:center">Totalmente Acuerdo</th>
                  <th style="text-align:center">Promedio</th>
                </tr>
              </thead>
              <tbody id="tablaCognitivos"></tbody>
              <tfoot>
                <tr class="total-row">
                  <td><strong>Promedio General</strong></td>
                  <td style="text-align:center"><strong id="promedioCognitivosTD">0%</strong></td>
                  <td style="text-align:center"><strong id="promedioCognitivosD">0%</strong></td>
                  <td style="text-align:center"><strong id="promedioCognitivosI">0%</strong></td>
                  <td style="text-align:center"><strong id="promedioCognitivosA">0%</strong></td>
                  <td style="text-align:center"><strong id="promedioCognitivosTA">0%</strong></td>
                  <td style="text-align:center"><strong id="promedioCognitivos">0%</strong></td>
                </tr>
              </tfoot>
            </table>
          </div>
        </div>
      </div>
      
      <div class="tab-content" id="tabla-ambiental">
        <div class="category-section">
          <div class="category-title">Sustentabilidad Ambiental</div>
          <div class="table-responsive">
            <table>
              <thead>
                <tr>
                  <th>Pregunta</th>
                  <th style="text-align:center">Totalmente Desacuerdo</th>
                  <th style="text-align:center">Desacuerdo</th>
                  <th style="text-align:center">Indiferente</th>
                  <th style="text-align:center">De Acuerdo</th>
                  <th style="text-align:center">Totalmente Acuerdo</th>
                  <th style="text-align:center">Promedio</th>
                </tr>
              </thead>
              <tbody id="tablaAmbiental"></tbody>
              <tfoot>
                <tr class="total-row">
                  <td><strong>Promedio General</strong></td>
                  <td style="text-align:center"><strong id="promedioAmbientalTD">0%</strong></td>
                  <td style="text-align:center"><strong id="promedioAmbientalD">0%</strong></td>
                  <td style="text-align:center"><strong id="promedioAmbientalI">0%</strong></td>
                  <td style="text-align:center"><strong id="promedioAmbientalA">0%</strong></td>
                  <td style="text-align:center"><strong id="promedioAmbientalTA">0%</strong></td>
                  <td style="text-align:center"><strong id="promedioAmbiental">0%</strong></td>
                </tr>
              </tfoot>
            </table>
          </div>
        </div>
      </div>
      
      <div class="tab-content" id="tabla-economica">
        <div class="category-section">
          <div class="category-title">Sustentabilidad Económica</div>
          <div class="table-responsive">
            <table>
              <thead>
                <tr>
                  <th>Pregunta</th>
                  <th style="text-align:center">Totalmente Desacuerdo</th>
                  <th style="text-align:center">Desacuerdo</th>
                  <th style="text-align:center">Indiferente</th>
                  <th style="text-align:center">De Acuerdo</th>
                  <th style="text-align:center">Totalmente Acuerdo</th>
                  <th style="text-align:center">Promedio</th>
                </tr>
              </thead>
              <tbody id="tablaEconomica"></tbody>
              <tfoot>
                <tr class="total-row">
                  <td><strong>Promedio General</strong></td>
                  <td style="text-align:center"><strong id="promedioEconomicaTD">0%</strong></td>
                  <td style="text-align:center"><strong id="promedioEconomicaD">0%</strong></td>
                  <td style="text-align:center"><strong id="promedioEconomicaI">0%</strong></td>
                  <td style="text-align:center"><strong id="promedioEconomicaA">0%</strong></td>
                  <td style="text-align:center"><strong id="promedioEconomicaTA">0%</strong></td>
                  <td style="text-align:center"><strong id="promedioEconomica">0%</strong></td>
                </tr>
              </tfoot>
            </table>
          </div>
        </div>
      </div>
      
      <div class="tab-content" id="tabla-comunitario">
        <div class="category-section">
          <div class="category-title">Desarrollo Comunitario</div>
          <div class="table-responsive">
            <table>
              <thead>
                <tr>
                  <th>Pregunta</th>
                  <th style="text-align:center">Totalmente Desacuerdo</th>
                  <th style="text-align:center">Desacuerdo</th>
                  <th style="text-align:center">Indiferente</th>
                  <th style="text-align:center">De Acuerdo</th>
                  <th style="text-align:center">Totalmente Acuerdo</th>
                  <th style="text-align:center">Promedio</th>
                </tr>
              </thead>
              <tbody id="tablaComunitario"></tbody>
              <tfoot>
                <tr class="total-row">
                  <td><strong>Promedio General</strong></td>
                  <td style="text-align:center"><strong id="promedioComunitarioTD">0%</strong></td>
                  <td style="text-align:center"><strong id="promedioComunitarioD">0%</strong></td>
                  <td style="text-align:center"><strong id="promedioComunitarioI">0%</strong></td>
                  <td style="text-align:center"><strong id="promedioComunitarioA">0%</strong></td>
                  <td style="text-align:center"><strong id="promedioComunitarioTA">0%</strong></td>
                  <td style="text-align:center"><strong id="promedioComunitario">0%</strong></td>
                </tr>
              </tfoot>
            </table>
          </div>
        </div>
      </div>
    </div>

    <footer>
      <p>Panel de Análisis de Comportamiento Proambiental - Cantón Daule</p>
    </footer>
  </main>

  <script>
  (async function(){
    // ---------- CONFIGURACIÓN ----------
    const SUPABASE_URL = "https://dutapywxsiuxboqsjqvf.supabase.co";
    const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImR1dGFweXd4c2l1eGJvcXNqcXZmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTM3MTk1MTUsImV4cCI6MjA2OTI5NTUxNX0.SBIDeV_WAWlyLs-ROD1ibXtqqY5bbbh0gouY8gRB9Y4";
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    // ---------- SELECTORES ----------
    const selectEstadoCivil = document.getElementById('selectEstadoCivil');
    const selectEducacion = document.getElementById('selectEducacion');
    const selectSituacionLaboral = document.getElementById('selectSituacionLaboral');
    const selectIngreso = document.getElementById('selectIngreso');
    const btnHelp = document.getElementById('btnHelp');

    // Elementos de información de filtros
    const estadoCivilInfo = document.getElementById('estadoCivilInfo');
    const educacionInfo = document.getElementById('educacionInfo');
    const situacionLaboralInfo = document.getElementById('situacionLaboralInfo');
    const ingresoInfo = document.getElementById('ingresoInfo');

    // Elementos de resumen
    const summaryTotal = document.getElementById('summaryTotal');
    const summaryHogar = document.getElementById('summaryHogar');
    const summaryEducacion = document.getElementById('summaryEducacion');
    const summaryLaboral = document.getElementById('summaryLaboral');
    const summaryHogarChange = document.getElementById('summaryHogarChange');
    const summaryEducacionChange = document.getElementById('summaryEducacionChange');
    const summaryLaboralChange = document.getElementById('summaryLaboralChange');

    // Variables globales para datos
    let currentData = [];
    let allData = [];
    let filterOptions = {
      estadosCiviles: [],
      nivelesEducacion: [],
      situacionesLaborales: [],
      nivelesIngreso: []
    };

    // Variables para control de gráficos
    let currentChartType = 'pie';

    // Inicializar la aplicación
    async function initApp() {
      await cargarTodosLosDatos();
      await inicializarFiltros();
      await actualizar();
      setupEventListeners();
    }

    // Configurar event listeners
    function setupEventListeners() {
      // Actualización automática al cambiar filtros
      selectEstadoCivil.addEventListener('change', async function() {
        await actualizar();
      });
      
      selectEducacion.addEventListener('change', async function() {
        await actualizar();
      });
      
      selectSituacionLaboral.addEventListener('change', async function() {
        await actualizar();
      });
      
      selectIngreso.addEventListener('change', async function() {
        await actualizar();
      });
      
      // Cambiar tipo de gráfico
      document.querySelectorAll('.chart-action-btn').forEach(btn => {
        btn.addEventListener('click', function() {
          // Remover clase activa de todos los botones
          document.querySelectorAll('.chart-action-btn').forEach(b => {
            b.classList.remove('active');
          });
          
          // Agregar clase activa al botón seleccionado
          this.classList.add('active');
          
          // Cambiar tipo de gráfico
          currentChartType = this.getAttribute('data-chart-type');
          actualizarGraficos();
        });
      });
      
      // Ayuda
      btnHelp.addEventListener('click', () => {
        mostrarModalAyuda();
      });
      
      // Manejar pestañas
      document.querySelectorAll('.tab').forEach(tab => {
        tab.addEventListener('click', () => {
          const tabId = tab.getAttribute('data-tab');
          
          // Actualizar pestañas activas
          document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
          document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
          
          tab.classList.add('active');
          document.getElementById(tabId).classList.add('active');
          
          // Renderizar gráficos específicos si es necesario
          if (tabId === 'sociocultural') {
            renderSocioculturalCharts();
          } else if (tabId === 'afectivos') {
            renderAfectivosCharts();
          } else if (tabId === 'cognitivos') {
            renderCognitivosCharts();
          } else if (tabId === 'ambiental') {
            renderAmbientalCharts();
          } else if (tabId === 'economica') {
            renderEconomicaCharts();
          } else if (tabId === 'comunitario') {
            renderComunitarioCharts();
          }
        });
      });
    }

    // Cargar todos los datos para análisis
    async function cargarTodosLosDatos() {
      const q = await supabase.from('cuestionario_comportamiento_proambiental_autosustentabilidad').select('*');
      if (q.error) {
        console.error(q.error);
        return;
      }
      allData = q.data || [];
    }

    // Cargar lista de filtros desde la BD
    async function inicializarFiltros() {
      // Obtener todos los datos para construir los filtros
      const q = await supabase.from('cuestionario_comportamiento_proambiental_autosustentabilidad').select('estado_civil, educacion_jefe_hogar, situacion_laboral_jefe_hogar, ingreso_mensual_jefe_hogar');
      if (q.error) {
        console.error(q.error);
        return;
      }
      const rows = q.data || [];

      // Construir opciones de filtro
      filterOptions.estadosCiviles = [...new Set(rows.map(r => r.estado_civil).filter(Boolean))].sort();
      filterOptions.nivelesEducacion = [...new Set(rows.map(r => r.educacion_jefe_hogar).filter(Boolean))].sort();
      filterOptions.situacionesLaborales = [...new Set(rows.map(r => r.situacion_laboral_jefe_hogar).filter(Boolean))].sort();
      filterOptions.nivelesIngreso = [...new Set(rows.map(r => r.ingreso_mensual_jefe_hogar).filter(Boolean))].sort();

      // Actualizar información de filtros
      estadoCivilInfo.textContent = `${filterOptions.estadosCiviles.length} estados civiles disponibles`;
      educacionInfo.textContent = `${filterOptions.nivelesEducacion.length} niveles educativos disponibles`;
      situacionLaboralInfo.textContent = `${filterOptions.situacionesLaborales.length} situaciones laborales disponibles`;
      ingresoInfo.textContent = `${filterOptions.nivelesIngreso.length} niveles de ingreso disponibles`;

      // Llenar selectores con todas las opciones iniciales
      llenarSelector(selectEstadoCivil, filterOptions.estadosCiviles);
      llenarSelector(selectEducacion, filterOptions.nivelesEducacion);
      llenarSelector(selectSituacionLaboral, filterOptions.situacionesLaborales);
      llenarSelector(selectIngreso, filterOptions.nivelesIngreso);
    }

    // Función para llenar un selector con opciones
    function llenarSelector(selector, opciones) {
      // Guardar la opción seleccionada actualmente
      const valorActual = selector.value;
      
      // Limpiar selector (excepto la primera opción)
      while (selector.options.length > 1) {
        selector.remove(1);
      }
      
      // Agregar nuevas opciones
      opciones.forEach(opcion => {
        const option = document.createElement('option');
        option.value = opcion;
        option.textContent = opcion;
        selector.appendChild(option);
      });
      
      // Restaurar la selección anterior si todavía existe
      if (valorActual && opciones.includes(valorActual)) {
        selector.value = valorActual;
      }
    }

    // Construir query según filtros y traer datos
    async function obtenerFiltrados() {
      let q = supabase.from('cuestionario_comportamiento_proambiental_autosustentabilidad').select('*');
      if (selectEstadoCivil.value) q = q.eq('estado_civil', selectEstadoCivil.value);
      if (selectEducacion.value) q = q.eq('educacion_jefe_hogar', selectEducacion.value);
      if (selectSituacionLaboral.value) q = q.eq('situacion_laboral_jefe_hogar', selectSituacionLaboral.value);
      if (selectIngreso.value) q = q.eq('ingreso_mensual_jefe_hogar', selectIngreso.value);
      
      const r = await q;
      if (r.error) {
        console.error(r.error);
        return [];
      }
      return r.data || [];
    }

    // Calcular distribuciones para diferentes categorías
    function calcularDistribuciones(rows) {
      // Distribución por estado civil
      const estadoCivilCounts = {};
      rows.forEach(row => {
        if (row.estado_civil) {
          estadoCivilCounts[row.estado_civil] = (estadoCivilCounts[row.estado_civil] || 0) + 1;
        }
      });
      const totalEstadoCivil = Object.values(estadoCivilCounts).reduce((a, b) => a + b, 0);
      const estadoCivil = {};
      Object.keys(estadoCivilCounts).forEach(key => {
        estadoCivil[key] = totalEstadoCivil > 0 ? (estadoCivilCounts[key] / totalEstadoCivil) * 100 : 0;
      });
      
      // Distribución por edades - contar filas con valores > 0
      const age0_10 = rows.filter(row => row.edad_0_10 > 0).length;
      const age11_25 = rows.filter(row => row.edad_11_25 > 0).length;
      const age26_50 = rows.filter(row => row.edad_26_50 > 0).length;
      const age51_90 = rows.filter(row => row.edad_51_90 > 0).length;
      const totalAge = age0_10 + age11_25 + age26_50 + age51_90;
      
      const edad = {
        '0-10 años': totalAge > 0 ? (age0_10 / totalAge) * 100 : 0,
        '11-25 años': totalAge > 0 ? (age11_25 / totalAge) * 100 : 0,
        '26-50 años': totalAge > 0 ? (age26_50 / totalAge) * 100 : 0,
        '51-90 años': totalAge > 0 ? (age51_90 / totalAge) * 100 : 0
      };
      
      // Distribución por educación
      const educacionCounts = {};
      rows.forEach(row => {
        if (row.educacion_jefe_hogar) {
          educacionCounts[row.educacion_jefe_hogar] = (educacionCounts[row.educacion_jefe_hogar] || 0) + 1;
        }
      });
      const totalEducacion = Object.values(educacionCounts).reduce((a, b) => a + b, 0);
      const educacion = {};
      Object.keys(educacionCounts).forEach(key => {
        educacion[key] = totalEducacion > 0 ? (educacionCounts[key] / totalEducacion) * 100 : 0;
      });
      
      // Distribución por situación laboral
      const laboralCounts = {};
      rows.forEach(row => {
        if (row.situacion_laboral_jefe_hogar) {
          laboralCounts[row.situacion_laboral_jefe_hogar] = (laboralCounts[row.situacion_laboral_jefe_hogar] || 0) + 1;
        }
      });
      const totalLaboral = Object.values(laboralCounts).reduce((a, b) => a + b, 0);
      const laboral = {};
      Object.keys(laboralCounts).forEach(key => {
        laboral[key] = totalLaboral > 0 ? (laboralCounts[key] / totalLaboral) * 100 : 0;
      });
      
      // Distribución por ingreso
      const ingresoCounts = {};
      rows.forEach(row => {
        if (row.ingreso_mensual_jefe_hogar) {
          ingresoCounts[row.ingreso_mensual_jefe_hogar] = (ingresoCounts[row.ingreso_mensual_jefe_hogar] || 0) + 1;
        }
      });
      const totalIngreso = Object.values(ingresoCounts).reduce((a, b) => a + b, 0);
      const ingreso = {};
      Object.keys(ingresoCounts).forEach(key => {
        ingreso[key] = totalIngreso > 0 ? (ingresoCounts[key] / totalIngreso) * 100 : 0;
      });
      
      // Distribución por tipo de hogar
      const hogarCounts = {};
      rows.forEach(row => {
        if (row.tipo_hogar) {
          hogarCounts[row.tipo_hogar] = (hogarCounts[row.tipo_hogar] || 0) + 1;
        }
      });
      const totalHogar = Object.values(hogarCounts).reduce((a, b) => a + b, 0);
      const hogar = {};
      Object.keys(hogarCounts).forEach(key => {
        hogar[key] = totalHogar > 0 ? (hogarCounts[key] / totalHogar) * 100 : 0;
      });
      
      return {
        estadoCivil,
        edad,
        educacion,
        laboral,
        ingreso,
        hogar,
        counts: {
          estadoCivil: estadoCivilCounts,
          edad: { '0-10 años': age0_10, '11-25 años': age11_25, '26-50 años': age26_50, '51-90 años': age51_90 },
          educacion: educacionCounts,
          laboral: laboralCounts,
          ingreso: ingresoCounts,
          hogar: hogarCounts
        }
      };
    }

    // Calcular distribuciones para preguntas Likert
    function calcularDistribucionesLikert(rows) {
      // Definir todas las preguntas por categoría
      const categorias = {
        sociocultural: [
          'conoce_desechos_solidos',
          'cree_comportamiento_adecuado_manejo',
          'separar_desechos_por_origen',
          'clasificacion_correcta_desechos',
          'comportamiento_comunidad_influye',
          'dedica_tiempo_reducir_reutilizar_reciclar',
          'desechos_solidos_problema_comunidad'
        ],
        afectivos: [
          'preocupa_exceso_desechos',
          'desechos_contaminan_ambiente',
          'afecta_emocionalmente_noticias_contaminacion',
          'frustracion_falta_acciones_ambientales',
          'importancia_planeta_futuras_generaciones'
        ],
        cognitivos: [
          'consciente_impacto_desechos_salud',
          'investiga_temas_ambientales',
          'consecuencias_acumulacion_desechos',
          'beneficios_reutilizar_residuo',
          'falta_informacion_obstaculo_gestion'
        ],
        ambiental: [
          'desechos_organicos_funcionalidad',
          'acumulacion_desechos_afecta_salud',
          'reduccion_reciclaje_reutilizacion_cuida_ambiente',
          'transformacion_desechos_nuevos_productos',
          'necesita_info_educacion_ambiental'
        ],
        economica: [
          'practica_separacion_reciclaje_ingreso',
          'desechos_hogar_reutilizados',
          'manejo_adecuado_desechos_aporta_desarrollo',
          'emprendimientos_reutilizacion_aportan_economia',
          'manejo_adecuado_desechos_oportunidad_emprendimiento'
        ],
        comunitario: [
          'reducir_residuos_eventos_concientizacion',
          'participaria_talleres_buenas_practicas',
          'manejo_adecuado_desechos_impacto_ambiente',
          'dispuesto_participar_emprendimiento_desechos',
          'participaria_feria_emprendimientos_desechos'
        ]
      };
      
      const distribuciones = {};
      const promedios = {};
      
      // Para cada categoría, calcular distribuciones
      Object.keys(categorias).forEach(categoria => {
        distribuciones[categoria] = {};
        promedios[categoria] = {
          'Totalmente desacuerdo': 0,
          'Desacuerdo': 0,
          'Indiferente': 0,
          'De acuerdo': 0,
          'Totalmente de acuerdo': 0,
          'Promedio': 0
        };
        
        categorias[categoria].forEach(pregunta => {
          distribuciones[categoria][pregunta] = {
            'Totalmente desacuerdo': 0,
            'Desacuerdo': 0,
            'Indiferente': 0,
            'De acuerdo': 0,
            'Totalmente de acuerdo': 0,
            'Promedio': 0
          };
          
          rows.forEach(row => {
            const respuesta = row[pregunta];
            if (respuesta && distribuciones[categoria][pregunta][respuesta] !== undefined) {
              distribuciones[categoria][pregunta][respuesta]++;
            }
          });
          
          // Calcular porcentajes y promedio
          const total = rows.length;
          let sumaPonderada = 0;
          Object.keys(distribuciones[categoria][pregunta]).forEach(respuesta => {
            if (respuesta !== 'Promedio') {
              const porcentaje = (distribuciones[categoria][pregunta][respuesta] / total) * 100;
              distribuciones[categoria][pregunta][respuesta] = porcentaje;
              
              // Calcular promedio ponderado (1-5)
              const valor = {
                'Totalmente desacuerdo': 1,
                'Desacuerdo': 2,
                'Indiferente': 3,
                'De acuerdo': 4,
                'Totalmente de acuerdo': 5
              }[respuesta];
              
              sumaPonderada += valor * (distribuciones[categoria][pregunta][respuesta] / 100);
            }
          });
          
          distribuciones[categoria][pregunta]['Promedio'] = (sumaPonderada / 5) * 100;
          
          // Acumular para promedios generales
          Object.keys(promedios[categoria]).forEach(respuesta => {
            if (respuesta !== 'Promedio') {
              promedios[categoria][respuesta] += distribuciones[categoria][pregunta][respuesta];
            }
          });
          promedios[categoria]['Promedio'] += distribuciones[categoria][pregunta]['Promedio'];
        });
        
        // Calcular promedios generales
        const numPreguntas = categorias[categoria].length;
        Object.keys(promedios[categoria]).forEach(respuesta => {
          promedios[categoria][respuesta] = promedios[categoria][respuesta] / numPreguntas;
        });
      });
      
      return { distribuciones, promedios };
    }

    // Renderizar gráficos demográficos
    function renderDemographicsCharts(distribuciones) {
      // Gráfico de estado civil
      renderDemographicChart('estadoCivilChart', 
        Object.keys(distribuciones.estadoCivil), 
        Object.values(distribuciones.estadoCivil),
        distribuciones.counts.estadoCivil,
        'Distribución por Estado Civil');
      
      // Gráfico de edades
      renderDemographicChart('edadChart', 
        Object.keys(distribuciones.edad), 
        Object.values(distribuciones.edad),
        distribuciones.counts.edad,
        'Distribución por Grupos de Edad');
      
      // Gráfico de educación
      renderDemographicChart('educacionChart', 
        Object.keys(distribuciones.educacion), 
        Object.values(distribuciones.educacion),
        distribuciones.counts.educacion,
        'Distribución por Nivel Educativo');
      
      // Gráfico de situación laboral
      renderDemographicChart('laboralChart', 
        Object.keys(distribuciones.laboral), 
        Object.values(distribuciones.laboral),
        distribuciones.counts.laboral,
        'Distribución por Situación Laboral');
      
      // Gráfico de ingreso
      renderDemographicChart('ingresoChart', 
        Object.keys(distribuciones.ingreso), 
        Object.values(distribuciones.ingreso),
        distribuciones.counts.ingreso,
        'Distribución por Ingreso Mensual');
      
      // Gráfico de tipo de hogar
      renderDemographicChart('hogarChart', 
        Object.keys(distribuciones.hogar), 
        Object.values(distribuciones.hogar),
        distribuciones.counts.hogar,
        'Distribución por Tipo de Hogar');
    }

    // Función para renderizar gráficos demográficos
    function renderDemographicChart(canvasId, labels, data, counts, title) {
      const ctx = document.getElementById(canvasId).getContext('2d');
      
      // Destruir gráfico existente si existe
      if (window[canvasId + 'Chart']) {
        window[canvasId + 'Chart'].destroy();
      }
      
      const colors = ['#4f46e5', '#0ea5e9', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6'];
      
      // Determinar tipo de gráfico según selección
      let chartType = currentChartType;
      
      // Configuración específica para cada tipo de gráfico
      let chartOptions = {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: {
            display: chartType === 'pie' || chartType === 'doughnut',
            position: 'right'
          },
          title: {
            display: true,
            text: title,
            font: {
              size: 14,
              weight: 'bold'
            },
            padding: {
              top: 10,
              bottom: 20
            }
          },
          tooltip: {
            callbacks: {
              label: function(context) {
                const label = context.dataset.label || '';
                const value = context.parsed ? context.parsed.y : context.raw;
                const count = counts[context.label] || 0;
                return `${label}: ${value.toFixed(1)}% (${count} personas)`;
              }
            }
          }
        }
      };
      
      // Configuración específica para gráficos de torta
      if (chartType === 'pie') {
        chartOptions.plugins.datalabels = {
          formatter: (value, ctx) => {
            // Si el valor es menor a 5%, mostrar la etiqueta fuera del gráfico
            if (value < 5) {
              return null; // No mostrar porcentajes pequeños dentro del gráfico
            }
            return value.toFixed(1) + '%';
          },
          color: '#fff',
          font: {
            weight: 'bold',
            size: 12
          },
          textShadowBlur: 10,
          textShadowColor: 'rgba(0,0,0,0.8)'
        };
        
        // Añadir leyenda mejorada para mostrar todos los porcentajes
        chartOptions.plugins.legend = {
          display: true,
          position: 'right',
          labels: {
            generateLabels: function(chart) {
              const data = chart.data;
              if (data.labels.length && data.datasets.length) {
                return data.labels.map((label, i) => {
                  const value = data.datasets[0].data[i];
                  return {
                    text: `${label}: ${value.toFixed(1)}%`,
                    fillStyle: data.datasets[0].backgroundColor[i],
                    strokeStyle: data.datasets[0].borderColor[i],
                    lineWidth: data.datasets[0].borderWidth,
                    hidden: false,
                    index: i
                  };
                });
              }
              return [];
            }
          }
        };
      }
      
      // Configuración específica para gráficos de barras
      if (chartType === 'bar') {
        chartOptions.scales = {
          y: {
            beginAtZero: true,
            max: 100,
            title: {
              display: true,
              text: 'Porcentaje (%)'
            }
          }
        };
        chartOptions.plugins.datalabels = {
          formatter: function(value) {
            return value.toFixed(1) + '%';
          },
          color: '#1e293b',
          font: {
            weight: 'bold',
            size: 12
          },
          anchor: 'end',
          align: 'top'
        };
      }
      
      // Configuración específica para gráficos de líneas
      if (chartType === 'line') {
        chartOptions.scales = {
          y: {
            beginAtZero: true,
            max: 100,
            title: {
              display: true,
              text: 'Porcentaje (%)'
            },
            ticks: {
              padding: 15 // Añadir espacio para evitar superposición
            }
          },
          x: {
            ticks: {
              padding: 10 // Añadir espacio para evitar superposición
            }
          }
        };
        chartOptions.plugins.datalabels = {
          formatter: function(value) {
            return value.toFixed(1) + '%';
          },
          color: '#1e293b',
          font: {
            weight: 'bold',
            size: 12
          },
          align: 'top',
          offset: 8 // Añadir offset para evitar superposición
        };
      }
      
      window[canvasId + 'Chart'] = new Chart(ctx, {
        type: chartType,
        data: {
          labels: labels,
          datasets: [{
            label: 'Porcentaje (%)',
            data: data,
            backgroundColor: colors.slice(0, labels.length),
            borderColor: colors.slice(0, labels.length).map(c => c.replace(')', ', 0.8)')),
            borderWidth: 1,
            fill: chartType === 'line' // Solo llenar para gráficos de línea
          }]
        },
        options: chartOptions,
        plugins: chartType === 'pie' || chartType === 'bar' || chartType === 'line' ? [ChartDataLabels] : []
      });
    }

    // Renderizar gráficos individuales para Determinantes Socioculturales
    function renderSocioculturalCharts() {
      if (!currentData.length) return;
      
      const { distribuciones: distribucionesLikert } = calcularDistribucionesLikert(currentData);
      const preguntasSociocultural = [
        'conoce_desechos_solidos',
        'cree_comportamiento_adecuado_manejo',
        'separar_desechos_por_origen',
        'clasificacion_correcta_desechos',
        'comportamiento_comunidad_influye',
        'dedica_tiempo_reducir_reutilizar_reciclar',
        'desechos_solidos_problema_comunidad'
      ];
      
      const titulosSociocultural = [
        '¿Conoce usted qué son los desechos sólidos domiciliarios?',
        '¿Cree usted que existe un comportamiento adecuado en el manejo de los desechos sólidos domiciliarios en la comunidad?',
        '¿Se debe separar los desechos sólidos según su tipo ejemplo: (papel - plástico - orgánico - inorgánico)?',
        '¿Es importante la correcta clasificación de los desechos sólidos orgánicos e inorgánicos en el hogar?',
        '¿Cree que el comportamiento de la comunidad influye en deterioro del medio ambiente?',
        '¿Dedica tiempo para reducir, reutilizar y/o reciclar los desechos sólidos que se generan en el hogar?',
        '¿Los desechos sólidos son un gran problema para la comunidad?'
      ];
      
      preguntasSociocultural.forEach((pregunta, index) => {
        const canvasId = `socioculturalChart${index + 1}`;
        const titulo = titulosSociocultural[index];
        const datos = distribucionesLikert.sociocultural[pregunta];
        
        renderQuestionChart(canvasId, datos, titulo, currentData.length);
      });
    }

    // Renderizar gráficos individuales para Determinantes Afectivos
    function renderAfectivosCharts() {
      if (!currentData.length) return;
      
      const { distribuciones: distribucionesLikert } = calcularDistribucionesLikert(currentData);
      const preguntasAfectivos = [
        'preocupa_exceso_desechos',
        'desechos_contaminan_ambiente',
        'afecta_emocionalmente_noticias_contaminacion',
        'frustracion_falta_acciones_ambientales',
        'importancia_planeta_futuras_generaciones'
      ];
      
      const titulosAfectivos = [
        '¿Le preocupa el exceso de desechos sólidos domiciliarios?',
        '¿Considera que los desechos sólidos domiciliarios intervienen en las consecuencias climáticas?',
        '¿Le afecta emocionalmente cuando escucha noticias acerca de los desastres naturales?',
        '¿Siente frustración debido a la falta de acciones significativas para abordar la generación de los desechos sólidos?',
        '¿Considera importante pensar en el tipo de planeta que dejaremos a las futuras generaciones?'
      ];
      
      preguntasAfectivos.forEach((pregunta, index) => {
        const canvasId = `afectivosChart${index + 1}`;
        const titulo = titulosAfectivos[index];
        const datos = distribucionesLikert.afectivos[pregunta];
        
        renderQuestionChart(canvasId, datos, titulo, currentData.length);
      });
    }

    // Renderizar gráficos individuales para Determinantes Cognitivos
    function renderCognitivosCharts() {
      if (!currentData.length) return;
      
      const { distribuciones: distribucionesLikert } = calcularDistribucionesLikert(currentData);
      const preguntasCognitivos = [
        'consciente_impacto_desechos_salud',
        'investiga_temas_ambientales',
        'consecuencias_acumulacion_desechos',
        'beneficios_reutilizar_residuo',
        'falta_informacion_obstaculo_gestion'
      ];
      
      const titulosCognitivos = [
        '¿Es consciente del impacto de los desechos sólidos domiciliarios en el medio ambiente?',
        '¿Investiga frecuentemente acerca de temas medio ambientales?',
        '¿Conoce las consecuencias de la acumulación de los desechos sólidos domiciliarios?',
        '¿Conoce los beneficios de reutilizar un residuo domiciliario?',
        '¿La falta de información es un obstáculo para la correcta gestión de los residuos sólidos domiciliario?'
      ];
      
      preguntasCognitivos.forEach((pregunta, index) => {
        const canvasId = `cognitivosChart${index + 1}`;
        const titulo = titulosCognitivos[index];
        const datos = distribucionesLikert.cognitivos[pregunta];
        
        renderQuestionChart(canvasId, datos, titulo, currentData.length);
      });
    }

    // Renderizar gráficos individuales para Sustentabilidad Ambiental
    function renderAmbientalCharts() {
      if (!currentData.length) return;
      
      const { distribuciones: distribucionesLikert } = calcularDistribucionesLikert(currentData);
      const preguntasAmbiental = [
        'desechos_organicos_funcionalidad',
        'acumulacion_desechos_afecta_salud',
        'reduccion_reciclaje_reutilizacion_cuida_ambiente',
        'transformacion_desechos_nuevos_productos',
        'necesita_info_educacion_ambiental'
      ];
      
      const titulosAmbiental = [
        '¿Los desechos orgánicos generados en el hogar pueden tener otra funcionalidad?',
        '¿La acumulación de desechos afectan a la salud de la población?',
        '¿La reducción, reciclaje y la reutilización de los desechos sólidos puede cuidar al medio ambiente y a la vida silvestre?',
        '¿Cree que la transformación de desechos sólidos en nuevos productos puede contribuir significativamente a la reducción de la generación de desechos?',
        '¿Necesita más información acerca de educación ambiental?'
      ];
      
      preguntasAmbiental.forEach((pregunta, index) => {
        const canvasId = `ambientalChart${index + 1}`;
        const titulo = titulosAmbiental[index];
        const datos = distribucionesLikert.ambiental[pregunta];
        
        renderQuestionChart(canvasId, datos, titulo, currentData.length);
      });
    }

    // Renderizar gráficos individuales para Sustentabilidad Económica
    function renderEconomicaCharts() {
      if (!currentData.length) return;
      
      const { distribuciones: distribucionesLikert } = calcularDistribucionesLikert(currentData);
      const preguntasEconomica = [
        'practica_separacion_reciclaje_ingreso',
        'desechos_hogar_reutilizados',
        'manejo_adecuado_desechos_aporta_desarrollo',
        'emprendimientos_reutilizacion_aportan_economia',
        'manejo_adecuado_desechos_oportunidad_emprendimiento'
      ];
      
      const titulosEconomica = [
        '¿En su hogar practica la separación de los desechos para el reciclaje y le representa algún ingreso?',
        '¿Los desechos sólidos generados en el hogar pueden ser reutilizados para una nueva función o creación de un producto?',
        '¿Cree que el manejo adecuado de los desechos sólidos domiciliarios podría aportar al desarrollo económico comunitario?',
        '¿Los emprendimientos en base a la reutilización de los desechos aporta a su economía?',
        '¿El manejo adecuado de los desechos sólidos domiciliarios ofrece oportunidades para el emprendimiento?'
      ];
      
      preguntasEconomica.forEach((pregunta, index) => {
        const canvasId = `economicaChart${index + 1}`;
        const titulo = titulosEconomica[index];
        const datos = distribucionesLikert.economica[pregunta];
        
        renderQuestionChart(canvasId, datos, titulo, currentData.length);
      });
    }

    // Renderizar gráficos individuales para Desarrollo Comunitario
    function renderComunitarioCharts() {
      if (!currentData.length) return;
      
      const { distribuciones: distribucionesLikert } = calcularDistribucionesLikert(currentData);
      const preguntasComunitario = [
        'reducir_residuos_eventos_concientizacion',
        'participaria_talleres_buenas_practicas',
        'manejo_adecuado_desechos_impacto_ambiente',
        'dispuesto_participar_emprendimiento_desechos',
        'participaria_feria_emprendimientos_desechos'
      ];
      
      const titulosComunitario = [
        '¿Es posible reducir la generación de residuos sólidos domiciliarios por medio de eventos de concientización?',
        '¿Participaría en talleres de buenas prácticas y capacitaciones para el correcto manejo de los desechos sólidos domiciliarios?',
        '¿El manejo adecuado de los desechos sólidos domiciliarios puede tener un impacto significativo al medio ambiente?',
        '¿Está dispuesto a participar en un emprendimiento en base al uso de los desechos sólidos?',
        '¿Participaría a una feria de emprendimientos comunitarios en base a desechos domiciliarios reutilizados?'
      ];
      
      preguntasComunitario.forEach((pregunta, index) => {
        const canvasId = `comunitarioChart${index + 1}`;
        const titulo = titulosComunitario[index];
        const datos = distribucionesLikert.comunitario[pregunta];
        
        renderQuestionChart(canvasId, datos, titulo, currentData.length);
      });
    }

    // Función para renderizar gráficos individuales de preguntas
    function renderQuestionChart(canvasId, data, title, total) {
      const ctx = document.getElementById(canvasId).getContext('2d');
      
      // Destruir gráfico existente si existe
      if (window[canvasId + 'Chart']) {
        window[canvasId + 'Chart'].destroy();
      }
      
      const respuestas = ['Totalmente desacuerdo', 'Desacuerdo', 'Indiferente', 'De acuerdo', 'Totalmente de acuerdo'];
      const valores = respuestas.map(respuesta => data[respuesta]);
      const colors = ['#ef4444', '#f59e0b', '#64748b', '#0ea5e9', '#10b981'];
      
      // Calcular cantidades para cada respuesta
      const cantidades = respuestas.map(respuesta => Math.round((data[respuesta] / 100) * total));
      
      // Configuración específica para cada tipo de gráfico
      let chartOptions = {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: {
            display: currentChartType === 'pie' || currentChartType === 'doughnut',
            position: 'right'
          },
          title: {
            display: true,
            text: title,
            font: {
              size: 14,
              weight: 'bold'
            },
            padding: {
              top: 10,
              bottom: 20
            }
          },
          tooltip: {
            callbacks: {
              label: function(context) {
                const label = context.dataset.label || '';
                const value = context.parsed ? context.parsed.y : context.raw;
                const index = context.dataIndex;
                const cantidad = cantidades[index];
                return `${label}: ${value.toFixed(1)}% (${cantidad} personas)`;
              }
            }
          }
        }
      };
      
      // Configuración específica para gráficos de torta
      if (currentChartType === 'pie') {
        chartOptions.plugins.datalabels = {
          formatter: (value, ctx) => {
            // Si el valor es menor a 5%, mostrar la etiqueta fuera del gráfico
            if (value < 5) {
              return null; // No mostrar porcentajes pequeños dentro del gráfico
            }
            return value.toFixed(1) + '%';
          },
          color: '#fff',
          font: {
            weight: 'bold',
            size: 12
          },
          textShadowBlur: 10,
          textShadowColor: 'rgba(0,0,0,0.8)'
        };
        
        // Añadir leyenda mejorada para mostrar todos los porcentajes
        chartOptions.plugins.legend = {
          display: true,
          position: 'right',
          labels: {
            generateLabels: function(chart) {
              const data = chart.data;
              if (data.labels.length && data.datasets.length) {
                return data.labels.map((label, i) => {
                  const value = data.datasets[0].data[i];
                  return {
                    text: `${label}: ${value.toFixed(1)}%`,
                    fillStyle: data.datasets[0].backgroundColor[i],
                    strokeStyle: data.datasets[0].borderColor[i],
                    lineWidth: data.datasets[0].borderWidth,
                    hidden: false,
                    index: i
                  };
                });
              }
              return [];
            }
          }
        };
      }
      
      // Configuración específica para gráficos de barras
      if (currentChartType === 'bar') {
        chartOptions.scales = {
          y: {
            beginAtZero: true,
            max: 100,
            title: {
              display: true,
              text: 'Porcentaje (%)'
            }
          }
        };
        chartOptions.plugins.datalabels = {
          formatter: function(value) {
            return value.toFixed(1) + '%';
          },
          color: '#1e293b',
          font: {
            weight: 'bold',
            size: 12
          },
          anchor: 'end',
          align: 'top'
        };
      }
      
      // Configuración específica para gráficos de líneas
      if (currentChartType === 'line') {
        chartOptions.scales = {
          y: {
            beginAtZero: true,
            max: 100,
            title: {
              display: true,
              text: 'Porcentaje (%)'
            },
            ticks: {
              padding: 15 // Añadir espacio para evitar superposición
            }
          },
          x: {
            ticks: {
              padding: 10 // Añadir espacio para evitar superposición
            }
          }
        };
        chartOptions.plugins.datalabels = {
          formatter: function(value) {
            return value.toFixed(1) + '%';
          },
          color: '#1e293b',
          font: {
            weight: 'bold',
            size: 12
          },
          align: 'top',
          offset: 8 // Añadir offset para evitar superposición
        };
      }
      
      window[canvasId + 'Chart'] = new Chart(ctx, {
        type: currentChartType,
        data: {
          labels: respuestas,
          datasets: [{
            label: 'Porcentaje (%)',
            data: valores,
            backgroundColor: colors,
            borderColor: colors.map(c => c.replace(')', ', 0.8)')),
            borderWidth: 1,
            fill: currentChartType === 'line' // Solo llenar para gráficos de línea
          }]
        },
        options: chartOptions,
        plugins: currentChartType === 'pie' || currentChartType === 'bar' || currentChartType === 'line' ? [ChartDataLabels] : []
      });
    }

    // Llenar tablas resumen
    function llenarTablasResumen(distribuciones, distribucionesLikert) {
      // Tabla de estado civil
      llenarTablaCategoria('tablaEstadoCivil', distribuciones.estadoCivil, distribuciones.counts.estadoCivil, 'totalEstadoCivil');
      
      // Tabla de edades
      llenarTablaCategoria('tablaEdades', distribuciones.edad, distribuciones.counts.edad, 'totalEdades');
      
      // Tabla de educación
      llenarTablaCategoria('tablaEducacion', distribuciones.educacion, distribuciones.counts.educacion, 'totalEducacion');
      
      // Tabla de situación laboral
      llenarTablaCategoria('tablaLaboral', distribuciones.laboral, distribuciones.counts.laboral, 'totalLaboral');
      
      // Tabla de ingreso
      llenarTablaCategoria('tablaIngreso', distribuciones.ingreso, distribuciones.counts.ingreso, 'totalIngreso');
      
      // Tabla de tipo de hogar
      llenarTablaCategoria('tablaHogar', distribuciones.hogar, distribuciones.counts.hogar, 'totalHogar');
      
      // Tablas de determinantes Likert
      llenarTablaLikert('tablaSociocultural', distribucionesLikert.distribuciones.sociocultural, distribucionesLikert.promedios.sociocultural, 'sociocultural');
      llenarTablaLikert('tablaAfectivos', distribucionesLikert.distribuciones.afectivos, distribucionesLikert.promedios.afectivos, 'afectivos');
      llenarTablaLikert('tablaCognitivos', distribucionesLikert.distribuciones.cognitivos, distribucionesLikert.promedios.cognitivos, 'cognitivos');
      llenarTablaLikert('tablaAmbiental', distribucionesLikert.distribuciones.ambiental, distribucionesLikert.promedios.ambiental, 'ambiental');
      llenarTablaLikert('tablaEconomica', distribucionesLikert.distribuciones.economica, distribucionesLikert.promedios.economica, 'economica');
      llenarTablaLikert('tablaComunitario', distribucionesLikert.distribuciones.comunitario, distribucionesLikert.promedios.comunitario, 'comunitario');
    }

    // Función para llenar tablas de categorías
    function llenarTablaCategoria(tablaId, distribucion, counts, totalId) {
      const tbody = document.getElementById(tablaId);
      tbody.innerHTML = '';
      
      let totalCount = 0;
      
      Object.keys(distribucion).forEach(categoria => {
        const count = counts[categoria] || 0;
        totalCount += count;
        
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${categoria}</td>
          <td style="text-align:right">${count}</td>
          <td style="text-align:right">${distribucion[categoria].toFixed(2)}%</td>
        `;
        tbody.appendChild(tr);
      });
      
      // Actualizar total
      document.getElementById(totalId).textContent = totalCount;
    }

    // Función para llenar tablas Likert
    function llenarTablaLikert(tablaId, distribucion, promedios, categoria) {
      const tbody = document.getElementById(tablaId);
      tbody.innerHTML = '';
      
      const respuestas = ['Totalmente desacuerdo', 'Desacuerdo', 'Indiferente', 'De acuerdo', 'Totalmente de acuerdo'];
      
      Object.keys(distribucion).forEach(pregunta => {
        const tr = document.createElement('tr');
        
        // Mapear pregunta a texto legible
        const preguntasMap = {
          'conoce_desechos_solidos': '¿Conoce usted qué son los desechos sólidos domiciliarios?',
          'cree_comportamiento_adecuado_manejo': '¿Cree usted que existe un comportamiento adecuado en el manejo de los desechos sólidos domiciliarios en la comunidad?',
          'separar_desechos_por_origen': '¿Se debe separar los desechos sólidos según su tipo ejemplo: (papel - plástico - orgánico - inorgánico)?',
          'clasificacion_correcta_desechos': '¿Es importante la correcta clasificación de los desechos sólidos orgánicos e inorgánicos en el hogar?',
          'comportamiento_comunidad_influye': '¿Cree que el comportamiento de la comunidad influye en deterioro del medio ambiente?',
          'dedica_tiempo_reducir_reutilizar_reciclar': '¿Dedica tiempo para reducir, reutilizar y/o reciclar los desechos sólidos que se generan en el hogar?',
          'desechos_solidos_problema_comunidad': '¿Los desechos sólidos son un gran problema para la comunidad?',
          'preocupa_exceso_desechos': '¿Le preocupa el exceso de desechos sólidos domiciliarios?',
          'desechos_contaminan_ambiente': '¿Considera que los desechos sólidos domiciliarios intervienen en las consecuencias climáticas?',
          'afecta_emocionalmente_noticias_contaminacion': '¿Le afecta emocionalmente cuando escucha noticias acerca de los desastres naturales?',
          'frustracion_falta_acciones_ambientales': '¿Siente frustración debido a la falta de acciones significativas para abordar la generación de los desechos sólidos?',
          'importancia_planeta_futuras_generaciones': '¿Considera importante pensar en el tipo de planeta que dejaremos a las futuras generaciones?',
          'consciente_impacto_desechos_salud': '¿Es consciente del impacto de los desechos sólidos domiciliarios en el medio ambiente?',
          'investiga_temas_ambientales': '¿Investiga frecuentemente acerca de temas medio ambientales?',
          'consecuencias_acumulacion_desechos': '¿Conoce las consecuencias de la acumulación de los desechos sólidos domiciliarios?',
          'beneficios_reutilizar_residuo': '¿Conoce los beneficios de reutilizar un residuo domiciliario?',
          'falta_informacion_obstaculo_gestion': '¿La falta de información es un obstáculo para la correcta gestión de los residuos sólidos domiciliario?',
          'desechos_organicos_funcionalidad': '¿Los desechos orgánicos generados en el hogar pueden tener otra funcionalidad?',
          'acumulacion_desechos_afecta_salud': '¿La acumulación de desechos afectan a la salud de la población?',
          'reduccion_reciclaje_reutilizacion_cuida_ambiente': '¿La reducción, reciclaje y la reutilización de los desechos sólidos puede cuidar al medio ambiente y a la vida silvestre?',
          'transformacion_desechos_nuevos_productos': '¿Cree que la transformación de desechos sólidos en nuevos productos puede contribuir significativamente a la reducción de la generación de desechos?',
          'necesita_info_educacion_ambiental': '¿Necesita más información acerca de educación ambiental?',
          'practica_separacion_reciclaje_ingreso': '¿En su hogar practica la separación de los desechos para el reciclaje y le representa algún ingreso?',
          'desechos_hogar_reutilizados': '¿Los desechos sólidos generados en el hogar pueden ser reutilizados para una nueva función o creación de un producto?',
          'manejo_adecuado_desechos_aporta_desarrollo': '¿Cree que el manejo adecuado de los desechos sólidos domiciliarios podría aportar al desarrollo económico comunitario?',
          'emprendimientos_reutilizacion_aportan_economia': '¿Los emprendimientos en base a la reutilización de los desechos aporta a su economía?',
          'manejo_adecuado_desechos_oportunidad_emprendimiento': '¿El manejo adecuado de los desechos sólidos domiciliarios ofrece oportunidades para el emprendimiento?',
          'reducir_residuos_eventos_concientizacion': '¿Es posible reducir la generación de residuos sólidos domiciliarios por medio de eventos de concientización?',
          'participaria_talleres_buenas_practicas': '¿Participaría en talleres de buenas prácticas y capacitaciones para el correcto manejo de los desechos sólidos domiciliarios?',
          'manejo_adecuado_desechos_impacto_ambiente': '¿El manejo adecuado de los desechos sólidos domiciliarios puede tener un impacto significativo al medio ambiente?',
          'dispuesto_participar_emprendimiento_desechos': '¿Está dispuesto a participar en un emprendimiento en base al uso de los desechos sólidos?',
          'participaria_feria_emprendimientos_desechos': '¿Participaría a una feria de emprendimientos comunitarios en base a desechos domiciliarios reutilizados?'
        };
        
        const preguntaTexto = preguntasMap[pregunta] || pregunta;
        
        let celdas = `<td>${preguntaTexto}</td>`;
        
        respuestas.forEach(respuesta => {
          celdas += `<td style="text-align:center">${distribucion[pregunta][respuesta].toFixed(1)}%</td>`;
        });
        
        celdas += `<td style="text-align:center"><strong>${distribucion[pregunta]['Promedio'].toFixed(1)}%</strong></td>`;
        
        tr.innerHTML = celdas;
        tbody.appendChild(tr);
      });
      
      // Actualizar promedios generales
      document.getElementById(`promedio${categoria.charAt(0).toUpperCase() + categoria.slice(1)}TD`).textContent = promedios['Totalmente desacuerdo'].toFixed(1) + '%';
      document.getElementById(`promedio${categoria.charAt(0).toUpperCase() + categoria.slice(1)}D`).textContent = promedios['Desacuerdo'].toFixed(1) + '%';
      document.getElementById(`promedio${categoria.charAt(0).toUpperCase() + categoria.slice(1)}I`).textContent = promedios['Indiferente'].toFixed(1) + '%';
      document.getElementById(`promedio${categoria.charAt(0).toUpperCase() + categoria.slice(1)}A`).textContent = promedios['De acuerdo'].toFixed(1) + '%';
      document.getElementById(`promedio${categoria.charAt(0).toUpperCase() + categoria.slice(1)}TA`).textContent = promedios['Totalmente de acuerdo'].toFixed(1) + '%';
      document.getElementById(`promedio${categoria.charAt(0).toUpperCase() + categoria.slice(1)}`).textContent = promedios['Promedio'].toFixed(1) + '%';
    }

    // Actualizar resúmenes
    function actualizarResumenes(distribuciones) {
      const totalRecords = currentData.length;
      summaryTotal.textContent = totalRecords;
      
      // Encontrar categorías predominantes
      const hogarPredominante = Object.keys(distribuciones.hogar).reduce((a, b) => 
        distribuciones.hogar[a] > distribuciones.hogar[b] ? a : b, '');
      const hogarPorcentaje = distribuciones.hogar[hogarPredominante] || 0;
      
      const educacionPredominante = Object.keys(distribuciones.educacion).reduce((a, b) => 
        distribuciones.educacion[a] > distribuciones.educacion[b] ? a : b, '');
      const educacionPorcentaje = distribuciones.educacion[educacionPredominante] || 0;
      
      const laboralPredominante = Object.keys(distribuciones.laboral).reduce((a, b) => 
        distribuciones.laboral[a] > distribuciones.laboral[b] ? a : b, '');
      const laboralPorcentaje = distribuciones.laboral[laboralPredominante] || 0;
      
      // Actualizar tarjetas de resumen
      summaryHogar.textContent = hogarPredominante;
      summaryEducacion.textContent = educacionPredominante;
      summaryLaboral.textContent = laboralPredominante;
      
      // Actualizar resúmenes de porcentajes
      summaryHogarChange.innerHTML = `<span>${hogarPorcentaje.toFixed(1)}% del total</span>`;
      summaryEducacionChange.innerHTML = `<span>${educacionPorcentaje.toFixed(1)}% del total</span>`;
      summaryLaboralChange.innerHTML = `<span>${laboralPorcentaje.toFixed(1)}% del total</span>`;
    }

    // Actualizar gráficos
    function actualizarGraficos() {
      if (!currentData.length) return;
      
      const distribuciones = calcularDistribuciones(currentData);
      renderDemographicsCharts(distribuciones);
      
      // Renderizar gráficos específicos si la pestaña está activa
      if (document.querySelector('.tab[data-tab="sociocultural"]').classList.contains('active')) {
        renderSocioculturalCharts();
      } else if (document.querySelector('.tab[data-tab="afectivos"]').classList.contains('active')) {
        renderAfectivosCharts();
      } else if (document.querySelector('.tab[data-tab="cognitivos"]').classList.contains('active')) {
        renderCognitivosCharts();
      } else if (document.querySelector('.tab[data-tab="ambiental"]').classList.contains('active')) {
        renderAmbientalCharts();
      } else if (document.querySelector('.tab[data-tab="economica"]').classList.contains('active')) {
        renderEconomicaCharts();
      } else if (document.querySelector('.tab[data-tab="comunitario"]').classList.contains('active')) {
        renderComunitarioCharts();
      }
    }

    // Mostrar modal de ayuda
    function mostrarModalAyuda() {
      alert('PANEL DE ANÁLISIS\n\nEste panel permite analizar datos del cuestionario de comportamiento proambiental del Cantón Daule.\n\n• Utilice los filtros para segmentar los datos por diferentes categorías demográficas\n• Explore las diferentes pestañas para ver visualizaciones específicas por categoría\n• Cambie entre tipos de gráficos (barras, torta, líneas) según su preferencia\n• Consulte las tablas resumen para datos detallados\n\nLos datos se actualizan automáticamente al aplicar filtros.');
    }

    // Acción principal: obtener datos, procesar y renderizar
    async function actualizar() {
      try {
        // Obtener datos del período actual
        currentData = await obtenerFiltrados();
        
        // Procesar datos
        const distribuciones = calcularDistribuciones(currentData);
        const distribucionesLikert = calcularDistribucionesLikert(currentData);
        
        // Renderizar
        renderDemographicsCharts(distribuciones);
        llenarTablasResumen(distribuciones, distribucionesLikert);
        actualizarResumenes(distribuciones);
        
        // Renderizar gráficos específicos si la pestaña está activa
        if (document.querySelector('.tab[data-tab="sociocultural"]').classList.contains('active')) {
          renderSocioculturalCharts();
        } else if (document.querySelector('.tab[data-tab="afectivos"]').classList.contains('active')) {
          renderAfectivosCharts();
        } else if (document.querySelector('.tab[data-tab="cognitivos"]').classList.contains('active')) {
          renderCognitivosCharts();
        } else if (document.querySelector('.tab[data-tab="ambiental"]').classList.contains('active')) {
          renderAmbientalCharts();
        } else if (document.querySelector('.tab[data-tab="economica"]').classList.contains('active')) {
          renderEconomicaCharts();
        } else if (document.querySelector('.tab[data-tab="comunitario"]').classList.contains('active')) {
          renderComunitarioCharts();
        }
      } catch (err) {
        console.error(err);
        alert('Error al actualizar. Revisa la consola para más detalles.');
      }
    }

    // Inicialización
    await initApp();

  })();
  </script>
</body>
</html>
