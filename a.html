<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Indicadores - Plataforma de Seguimiento Ambiental</title>

  <!-- TailwindCSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Supabase -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    .fade-in { animation: fadeIn 0.6s ease-in-out; }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
  </style>
</head>

<body class="bg-gray-50 text-gray-900 font-sans">
  <!-- Encabezado -->
  <header class="bg-emerald-700 text-white shadow-lg p-6">
    <div class="flex justify-between items-center">
      <h1 class="text-2xl font-bold tracking-wide">ðŸ“Š Panel de Indicadores Ambientales</h1>
      <button id="refreshBtn" class="bg-white text-emerald-700 px-4 py-2 rounded-lg font-semibold hover:bg-emerald-50 shadow transition">
        ðŸ”„ Actualizar
      </button>
    </div>
    <p class="text-sm opacity-80 mt-1">Seguimiento de indicadores del proyecto FCI-087 - Daule</p>
  </header>

  <!-- Contenido -->
  <main class="max-w-7xl mx-auto p-6 space-y-8">
    
    <!-- Filtros -->
    <section class="bg-white rounded-xl shadow-md p-4 flex flex-col md:flex-row justify-between items-center gap-4">
      <input type="text" id="searchInput" placeholder="Buscar por encuestado o grupo..." class="border border-gray-300 rounded-lg px-3 py-2 w-full md:w-1/3 focus:ring-2 focus:ring-emerald-400 focus:outline-none" />
      <div class="flex gap-3">
        <select id="filterSexo" class="border border-gray-300 rounded-lg px-3 py-2">
          <option value="">Sexo: Todos</option>
          <option value="Masculino">Masculino</option>
          <option value="Femenino">Femenino</option>
        </select>
        <select id="filterGrupo" class="border border-gray-300 rounded-lg px-3 py-2">
          <option value="">Grupo: Todos</option>
          <option value="A">A</option>
          <option value="B">B</option>
          <option value="C">C</option>
        </select>
      </div>
    </section>

    <!-- Indicadores -->
    <section class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 fade-in">
      <div class="bg-white rounded-xl shadow-md p-5 text-center border-t-4 border-emerald-600">
        <h3 class="text-gray-500 text-sm">Total de Registros</h3>
        <p id="totalRegistros" class="text-3xl font-bold text-emerald-700">0</p>
      </div>
      <div class="bg-white rounded-xl shadow-md p-5 text-center border-t-4 border-blue-600">
        <h3 class="text-gray-500 text-sm">Edad Promedio</h3>
        <p id="edadPromedio" class="text-3xl font-bold text-blue-700">0</p>
      </div>
      <div class="bg-white rounded-xl shadow-md p-5 text-center border-t-4 border-pink-600">
        <h3 class="text-gray-500 text-sm">Femenino (%)</h3>
        <p id="porcentajeFemenino" class="text-3xl font-bold text-pink-600">0%</p>
      </div>
      <div class="bg-white rounded-xl shadow-md p-5 text-center border-t-4 border-indigo-600">
        <h3 class="text-gray-500 text-sm">Masculino (%)</h3>
        <p id="porcentajeMasculino" class="text-3xl font-bold text-indigo-600">0%</p>
      </div>
    </section>

    <!-- GrÃ¡ficos -->
    <section class="grid md:grid-cols-2 gap-8 fade-in">
      <div class="bg-white p-6 rounded-xl shadow-md">
        <h3 class="text-lg font-semibold text-gray-700 mb-4 text-center">DistribuciÃ³n por Sexo</h3>
        <canvas id="graficoSexo" height="150"></canvas>
      </div>

      <div class="bg-white p-6 rounded-xl shadow-md">
        <h3 class="text-lg font-semibold text-gray-700 mb-4 text-center">DistribuciÃ³n por Grupo</h3>
        <canvas id="graficoGrupo" height="150"></canvas>
      </div>
    </section>

    <div id="loader" class="text-center text-emerald-600 mt-8 hidden">Cargando indicadores...</div>
  </main>

  <!-- Pie de pÃ¡gina -->
  <footer class="text-center text-gray-500 py-6 text-sm">
    Â© 2025 Plataforma de Seguimiento Ambiental â€” Basado en Supabase & Chart.js
  </footer>

  <script>
    // ConfiguraciÃ³n Supabase
    const SUPABASE_URL = "https://dutapywxsiuxboqsjqvf.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImR1dGFweXd4c2l1eGJvcXNqcXZmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTM3MTk1MTUsImV4cCI6MjA2OTI5NTUxNX0.SBIDeV_WAWlyLs-ROD1ibXtqqY5bbbh0gouY8gRB9Y4";
    const { createClient } = supabase;
    const supabaseClient = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // Referencias DOM
    const totalRegistros = document.getElementById("totalRegistros");
    const edadPromedio = document.getElementById("edadPromedio");
    const porcentajeFemenino = document.getElementById("porcentajeFemenino");
    const porcentajeMasculino = document.getElementById("porcentajeMasculino");
    const loader = document.getElementById("loader");
    const graficoSexo = document.getElementById("graficoSexo");
    const graficoGrupo = document.getElementById("graficoGrupo");
    const searchInput = document.getElementById("searchInput");
    const filterSexo = document.getElementById("filterSexo");
    const filterGrupo = document.getElementById("filterGrupo");
    const refreshBtn = document.getElementById("refreshBtn");

    let chartSexo, chartGrupo;

    // FunciÃ³n principal
    async function cargarIndicadores() {
      loader.classList.remove("hidden");

      let query = supabaseClient.from("cuestionario_comportamiento_proambiental_autosustentabilidad").select("*");
      if (filterSexo.value) query = query.eq("sexo", filterSexo.value);
      if (filterGrupo.value) query = query.eq("grupo", filterGrupo.value);

      const { data, error } = await query;
      loader.classList.add("hidden");

      if (error) {
        alert("Error al cargar indicadores: " + error.message);
        return;
      }

      const search = searchInput.value.toLowerCase();
      const filtrados = data.filter(d =>
        d.nombre_encuestado?.toLowerCase().includes(search)
      );

      actualizarIndicadores(filtrados);
    }

    function actualizarIndicadores(data) {
      const total = data.length;
      totalRegistros.textContent = total;

      const edades = data.map(d => d.edad).filter(n => !isNaN(n));
      edadPromedio.textContent = edades.length ? Math.round(edades.reduce((a, b) => a + b, 0) / edades.length) : 0;

      const totalF = data.filter(d => d.sexo === "Femenino").length;
      const totalM = data.filter(d => d.sexo === "Masculino").length;

      porcentajeFemenino.textContent = total ? ((totalF / total) * 100).toFixed(1) + "%" : "0%";
      porcentajeMasculino.textContent = total ? ((totalM / total) * 100).toFixed(1) + "%" : "0%";

      actualizarGraficos(data);
    }

    function actualizarGraficos(data) {
      const sexoLabels = ["Masculino", "Femenino"];
      const sexoData = [
        data.filter(d => d.sexo === "Masculino").length,
        data.filter(d => d.sexo === "Femenino").length,
      ];

      const grupos = [...new Set(data.map(d => d.grupo).filter(Boolean))];
      const conteoGrupos = grupos.map(g => data.filter(d => d.grupo === g).length);

      if (chartSexo) chartSexo.destroy();
      if (chartGrupo) chartGrupo.destroy();

      chartSexo = new Chart(graficoSexo, {
        type: "doughnut",
        data: {
          labels: sexoLabels,
          datasets: [
            { data: sexoData, backgroundColor: ["#16a34a", "#86efac"] },
          ],
        },
        options: { plugins: { legend: { position: "bottom" } } },
      });

      chartGrupo = new Chart(graficoGrupo, {
        type: "bar",
        data: {
          labels: grupos,
          datasets: [
            {
              label: "Registros por grupo",
              data: conteoGrupos,
              backgroundColor: "#16a34a",
            },
          ],
        },
        options: {
          responsive: true,
          scales: { y: { beginAtZero: true } },
          plugins: { legend: { display: false } },
        },
      });
    }

    // Eventos
    searchInput.addEventListener("input", cargarIndicadores);
    filterSexo.addEventListener("change", cargarIndicadores);
    filterGrupo.addEventListener("change", cargarIndicadores);
    refreshBtn.addEventListener("click", cargarIndicadores);

    // Carga inicial
    cargarIndicadores();
  </script>
</body>
</html>
