<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Dashboard - Cuestionario Ambiental</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body class="bg-gray-50 text-gray-800">
  <header class="bg-green-600 text-white shadow p-5">
    <h1 class="text-3xl font-bold text-center">Dashboard de Comportamiento Proambiental</h1>
    <p class="text-center text-sm opacity-90 mt-1">VisualizaciÃ³n de datos desde Supabase</p>
  </header>

  <main class="max-w-7xl mx-auto p-6">
    <!-- Controles -->
    <section class="mb-6 flex flex-col md:flex-row justify-between items-center gap-4">
      <div class="flex gap-3">
        <button id="refreshBtn" class="bg-green-600 text-white px-4 py-2 rounded-lg shadow hover:bg-green-700 transition">
          ðŸ”„ Actualizar datos
        </button>
        <input type="text" id="searchInput" placeholder="Buscar por encuestado..." class="border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-green-400 focus:outline-none" />
      </div>

      <div class="flex gap-3">
        <select id="filterSexo" class="border border-gray-300 rounded-lg px-3 py-2">
          <option value="">Sexo: Todos</option>
          <option value="Masculino">Masculino</option>
          <option value="Femenino">Femenino</option>
        </select>
        <select id="filterGrupo" class="border border-gray-300 rounded-lg px-3 py-2">
          <option value="">Grupo: Todos</option>
          <option value="A">A</option>
          <option value="B">B</option>
          <option value="C">C</option>
        </select>
      </div>
    </section>

    <!-- MÃ©tricas -->
    <section class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
      <div class="bg-white p-4 rounded-xl shadow text-center">
        <h3 class="text-gray-500 text-sm">Total de Encuestas</h3>
        <p id="totalRegistros" class="text-2xl font-bold text-green-600">0</p>
      </div>
      <div class="bg-white p-4 rounded-xl shadow text-center">
        <h3 class="text-gray-500 text-sm">Edad Promedio</h3>
        <p id="edadPromedio" class="text-2xl font-bold text-green-600">0</p>
      </div>
    </section>

    <!-- Tabla -->
    <section class="bg-white shadow rounded-xl overflow-hidden">
      <div class="overflow-x-auto">
        <table class="min-w-full text-sm text-left">
          <thead class="bg-green-100 text-gray-700 uppercase">
            <tr>
              <th class="px-4 py-2">ID</th>
              <th class="px-4 py-2">Fecha</th>
              <th class="px-4 py-2">Encuestador</th>
              <th class="px-4 py-2">Encuestado</th>
              <th class="px-4 py-2">Sexo</th>
              <th class="px-4 py-2">Edad</th>
              <th class="px-4 py-2">Grupo</th>
              <th class="px-4 py-2">Subgrupo</th>
            </tr>
          </thead>
          <tbody id="tablaDatos" class="divide-y divide-gray-200 text-gray-700">
          </tbody>
        </table>
      </div>

      <div id="loader" class="text-center p-4 text-green-600 hidden">
        Cargando datos...
      </div>
    </section>

    <!-- GrÃ¡fico -->
    <section class="bg-white mt-8 p-6 rounded-xl shadow">
      <h3 class="text-xl font-semibold text-center mb-4">DistribuciÃ³n por Sexo</h3>
      <canvas id="graficoSexo" height="100"></canvas>
    </section>
  </main>

  <footer class="text-center text-gray-500 py-4 text-sm">
    Â© 2025 Dashboard Ambiental â€” Desarrollado con Supabase & TailwindCSS
  </footer>

  <script>
    // Configura tus credenciales de Supabase
    const SUPABASE_URL = "https://dutapywxsiuxboqsjqvf.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImR1dGFweXd4c2l1eGJvcXNqcXZmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTM3MTk1MTUsImV4cCI6MjA2OTI5NTUxNX0.SBIDeV_WAWlyLs-ROD1ibXtqqY5bbbh0gouY8gRB9Y4";
    const { createClient } = supabase;
    const supabaseClient = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    const tabla = document.getElementById("tablaDatos");
    const loader = document.getElementById("loader");
    const totalRegistros = document.getElementById("totalRegistros");
    const edadPromedio = document.getElementById("edadPromedio");
    const searchInput = document.getElementById("searchInput");
    const filterSexo = document.getElementById("filterSexo");
    const filterGrupo = document.getElementById("filterGrupo");
    const refreshBtn = document.getElementById("refreshBtn");
    let grafico;

    async function cargarDatos() {
      loader.classList.remove("hidden");
      tabla.innerHTML = "";

      let query = supabaseClient.from("cuestionario_comportamiento_proambiental_autosustentabilidad").select("*");

      // Filtros
      if (filterSexo.value) query = query.eq("sexo", filterSexo.value);
      if (filterGrupo.value) query = query.eq("grupo", filterGrupo.value);

      const { data, error } = await query.order("id", { ascending: false });
      loader.classList.add("hidden");

      if (error) {
        tabla.innerHTML = `<tr><td colspan="8" class="text-center text-red-500 p-4">Error al cargar datos: ${error.message}</td></tr>`;
        return;
      }

      const searchTerm = searchInput.value.toLowerCase();
      const filtrados = data.filter(d =>
        d.nombre_encuestado?.toLowerCase().includes(searchTerm)
      );

      if (filtrados.length === 0) {
        tabla.innerHTML = `<tr><td colspan="8" class="text-center p-4">No se encontraron resultados.</td></tr>`;
        return;
      }

      filtrados.forEach(row => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td class="px-4 py-2">${row.id}</td>
          <td class="px-4 py-2">${row.fecha || ""}</td>
          <td class="px-4 py-2">${row.nombre_encuestador || ""}</td>
          <td class="px-4 py-2">${row.nombre_encuestado || ""}</td>
          <td class="px-4 py-2">${row.sexo || ""}</td>
          <td class="px-4 py-2">${row.edad || ""}</td>
          <td class="px-4 py-2">${row.grupo || ""}</td>
          <td class="px-4 py-2">${row.subgrupo || ""}</td>
        `;
        tabla.appendChild(tr);
      });

      totalRegistros.textContent = filtrados.length;
      edadPromedio.textContent = Math.round(filtrados.reduce((a, b) => a + (b.edad || 0), 0) / filtrados.length);

      actualizarGrafico(filtrados);
    }

    function actualizarGrafico(data) {
      const sexos = ["Masculino", "Femenino"];
      const conteos = sexos.map(s => data.filter(d => d.sexo === s).length);

      if (grafico) grafico.destroy();

      const ctx = document.getElementById("graficoSexo").getContext("2d");
      grafico = new Chart(ctx, {
        type: "doughnut",
        data: {
          labels: sexos,
          datasets: [{
            data: conteos,
            backgroundColor: ["#16a34a", "#86efac"]
          }]
        },
        options: {
          plugins: { legend: { position: "bottom" } }
        }
      });
    }

    // Eventos
    refreshBtn.addEventListener("click", cargarDatos);
    searchInput.addEventListener("input", cargarDatos);
    filterSexo.addEventListener("change", cargarDatos);
    filterGrupo.addEventListener("change", cargarDatos);

    // Carga inicial
    cargarDatos();
  </script>
</body>
</html>
