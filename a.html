<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Dashboard de Indicadores - Encuesta Proambiental</title>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <style>html,body,#app{height:100%} .card{background:rgba(255,255,255,0.9);backdrop-filter:blur(6px)}</style>
</head>
<body class="bg-gradient-to-r from-green-100 to-green-50 p-6 font-sans">
  <div id="app" class="max-w-7xl mx-auto">
    <header class="mb-6">
      <h1 class="text-3xl font-bold text-gray-800">Dashboard de indicadores (Encuesta Proambiental)</h1>
      <p class="text-sm text-gray-600">Conexión en tiempo real a Supabase — despliegue en Vercel listo.</p>
    </header>

    <main class="grid grid-cols-1 md:grid-cols-4 gap-6">
      <section class="md:col-span-1 card p-4 rounded-lg shadow space-y-4">
  <h2 class="font-semibold mb-2 text-lg">Panel de Filtros</h2>

  <div>
    <label class="block text-xs text-gray-600">Indicador a visualizar</label>
    <select id="fieldSelect" class="w-full p-2 border rounded mb-3"></select>
  </div>

  <div>
    <label class="block text-xs text-gray-600">Tipo de gráfico</label>
    <select id="chartType" class="w-full p-2 border rounded mb-3">
      <option value="pie">Torta</option>
      <option value="bar">Barras</option>
      <option value="line">Línea</option>
      <option value="doughnut">Dona</option>
      <option value="polarArea">Polar</option>
      <option value="radar">Radar</option>
    </select>
  </div>

  <div>
    <label class="block text-xs text-gray-600">Filtrar por Sexo</label>
    <select id="filterSexo" class="w-full p-2 border rounded">
      <option value="">Todos</option>
      <option value="Masculino">Masculino</option>
      <option value="Femenino">Femenino</option>
      <option value="Otro">Otro</option>
    </select>
  </div>

  <div>
    <label class="block text-xs text-gray-600">Filtrar por Grupo</label>
    <input id="filterGrupo" class="w-full p-2 border rounded" placeholder="Ej: A, B, C..." />
  </div>

  <div>
    <label class="block text-xs text-gray-600">Filtrar por Subgrupo</label>
    <input id="filterSubgrupo" class="w-full p-2 border rounded" placeholder="Ej: 1, 2, 3..." />
  </div>

  <div>
    <label class="block text-xs text-gray-600">Mostrar Totales / %</label>
    <div class="flex space-x-2 mt-1">
      <label class="flex items-center space-x-1 text-sm"><input id="showTotals" type="checkbox" checked> <span>Totales</span></label>
      <label class="flex items-center space-x-1 text-sm"><input id="normalize" type="checkbox"> <span>Porcentajes</span></label>
    </div>
  </div>

  <div class="mt-6 p-3 text-xs text-gray-600 bg-gray-100 rounded-lg">
    <p>Última actualización: <span id="lastUpdate">—</span></p>
    <p>Registros filtrados: <span id="countRecords">0</span></p>
  </div>
</section>

      <section class="md:col-span-3 card p-4 rounded-lg shadow">
        <div class="flex items-center justify-between mb-4">
          <h2 class="font-semibold">Visualización</h2>
          <div class="text-sm text-gray-600">Cambio de gráfico se actualiza automáticamente</div>
        </div>

        <canvas id="mainChart" height="220"></canvas>

        <div class="mt-6 grid grid-cols-1 md:grid-cols-3 gap-4">
          <div class="p-3 bg-white rounded shadow-sm">
            <h3 class="text-sm font-medium">Edad - distribución familia</h3>
            <div id="ageSummary" class="text-sm text-gray-700 mt-2">Cargando...</div>
          </div>
          <div class="p-3 bg-white rounded shadow-sm">
            <h3 class="text-sm font-medium">Género</h3>
            <div id="genderSummary" class="text-sm text-gray-700 mt-2">Cargando...</div>
          </div>
          <div class="p-3 bg-white rounded shadow-sm">
            <h3 class="text-sm font-medium">Separación de residuos</h3>
            <div id="separationSummary" class="text-sm text-gray-700 mt-2">Cargando...</div>
          </div>
        </div>
      </section>
    </main>

    <footer class="mt-8 text-xs text-gray-500">Hecho para despliegue en Vercel • Usa tu NEXT_PUBLIC_SUPABASE_URL y NEXT_PUBLIC_SUPABASE_ANON_KEY</footer>
  </div>

  <!-- dependencias -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/supabase.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

  <script>
    // --- CONFIGURA AQUÍ (ya los proporcionaste, se usan tal cual) ---
    const SUPABASE_URL = 'https://dutapywxsiuxboqsjqvf.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImR1dGFweXd4c2l1eGJvcXNqcXZmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTM3MTk1MTUsImV4cCI6MjA2OTI5NTUxNX0.SBIDeV_WAWlyLs-ROD1ibXtqqY5bbbh0gouY8gRB9Y4';

    // tabla
    const TABLE = 'cuestionario_comportamiento_proambiental_autosustentabilidad';

    const supabase = supabaseLib.createClient(SUPABASE_URL, SUPABASE_KEY);

    // campos que queremos ofrecer como indicadores (puedes añadir más si quieres)
    const INDICATORS = [
      {value: 'sexo', label: 'Sexo'},
      {value: 'edad_0_10', label: 'Rango edad 0-10 (conteo por registro)'},
      {value: 'edad_11_25', label: 'Rango edad 11-25 (conteo por registro)'},
      {value: 'edad_26_50', label: 'Rango edad 26-50 (conteo por registro)'},
      {value: 'edad_51_90', label: 'Rango edad 51-90 (conteo por registro)'},
      {value: 'educacion_jefe_hogar', label: 'Educación jefe de hogar'},
      {value: 'conoce_desechos_solidos', label: 'Conoce desechos sólidos'},
      {value: 'separar_desechos_por_origen', label: 'Separa desechos por origen'},
      {value: 'practica_separacion_reciclaje_ingreso', label: 'Practica separación (ingreso)'},
      {value: 'desechos_hogar_reutilizados', label: 'Desechos del hogar reutilizados'}
    ];

    // UI refs
    const fieldSelect = document.getElementById('fieldSelect');
    const chartTypeSelect = document.getElementById('chartType');
    const lastUpdateEl = document.getElementById('lastUpdate');
    const countRecordsEl = document.getElementById('countRecords');
    const ageSummary = document.getElementById('ageSummary');
    const genderSummary = document.getElementById('genderSummary');
    const separationSummary = document.getElementById('separationSummary');

    // rellenar select de indicadores
    INDICATORS.forEach(i => {
      const opt = document.createElement('option'); opt.value = i.value; opt.textContent = i.label; fieldSelect.appendChild(opt);
    });

    // Chart.js instance
    let chart = null;

    async function fetchAllData() {
      const { data, error } = await supabase.from(TABLE).select('*');
      if (error) {
        console.error('Error leyendo datos:', error);
        return [];
      }
      return data || [];
    }

    function buildCategoryCounts(records, field) {
      // campos numéricos de rangos especiales
      if (['edad_0_10','edad_11_25','edad_26_50','edad_51_90'].includes(field)) {
        // sumar todos los registros para ese campo
        let total = 0; let counts = {};
        records.forEach(r => {
          const val = Number(r[field]) || 0;
          counts[field] = (counts[field] || 0) + val;
          total += val;
        });
        // si total es 0 pero existen registros con num_integrantes, intentamos distribuir
        if (total === 0) {
          let sumIntegrantes = 0;
          records.forEach(r => sumIntegrantes += Number(r.num_integrantes_familia) || 0);
          // distribución uniforme como fallback
          const ranges = ['edad_0_10','edad_11_25','edad_26_50','edad_51_90'];
          const perRange = Math.floor(sumIntegrantes / ranges.length) || 0;
          const remainder = sumIntegrantes - perRange * ranges.length;
          const result = {}; ranges.forEach((rg,idx)=> result[rg]=perRange + (idx===0? remainder:0));
          return {labels: ['0-10','11-25','26-50','51-90'], values: [result.edad_0_10, result.edad_11_25, result.edad_26_50, result.edad_51_90] };
        }

        return { labels: [field], values: [counts[field] || 0] };
      }

      // si el campo es numérico almacenado como conteo por registro, sumar
      const numeric = records.every(r => r[field] === null || !isNaN(Number(r[field])));
      if (numeric) {
        let sum = 0; records.forEach(r => sum += Number(r[field]) || 0);
        return { labels: [field], values: [sum] };
      }

      // para campos categóricos, agrupar por valor
      const map = new Map();
      records.forEach(r => {
        const v = (r[field] === null || r[field] === undefined || r[field] === '') ? 'Sin dato' : String(r[field]);
        map.set(v, (map.get(v) || 0) + 1);
      });
      const labels = Array.from(map.keys());
      const values = labels.map(l => map.get(l));
      return { labels, values };
    }

    function aggregateAgeRanges(records) {
      const sums = { '0-10':0, '11-25':0, '26-50':0, '51-90':0 };
      records.forEach(r => {
        sums['0-10'] += Number(r.edad_0_10) || 0;
        sums['11-25'] += Number(r.edad_11_25) || 0;
        sums['26-50'] += Number(r.edad_26_50) || 0;
        sums['51-90'] += Number(r.edad_51_90) || 0;
        // si todas las edades vienen en 0 y hay num_integrantes, distribuir por defecto
        const sumRanges = (Number(r.edad_0_10)||0)+(Number(r.edad_11_25)||0)+(Number(r.edad_26_50)||0)+(Number(r.edad_51_90)||0);
        if (sumRanges === 0 && Number(r.num_integrantes_familia)) {
          const n = Number(r.num_integrantes_familia);
          // heurística simple: si tiene adultos, la mayor parte en 26-50
          const a = Math.floor(n*0.15); // 0-10
          const b = Math.floor(n*0.25); // 11-25
          const c = Math.floor(n*0.45); // 26-50
          const d = n - (a+b+c);
          sums['0-10'] += a; sums['11-25'] += b; sums['26-50'] += c; sums['51-90'] += d;
        }
      });
      return sums;
    }

    function updateSummaries(records) {
      const ages = aggregateAgeRanges(records);
      ageSummary.innerHTML = `0-10: ${ages['0-10']} <br> 11-25: ${ages['11-25']} <br> 26-50: ${ages['26-50']} <br> 51-90: ${ages['51-90']}`;

      // gender
      const genderMap = {};
      records.forEach(r => { const g = r.sexo || 'Sin dato'; genderMap[g] = (genderMap[g]||0)+1; });
      genderSummary.innerHTML = Object.entries(genderMap).map(([k,v])=>`${k}: ${v}`).join('<br>');

      // separation
      const sepMap = {};
      records.forEach(r => { const s = r.separar_desechos_por_origen || 'Sin dato'; sepMap[s] = (sepMap[s]||0)+1; });
      separationSummary.innerHTML = Object.entries(sepMap).map(([k,v])=>`${k}: ${v}`).join('<br>');

      countRecordsEl.textContent = records.length;
      lastUpdateEl.textContent = new Date().toLocaleString();
    }

    function renderChart({labels, values}, chartType, normalize=false) {
      const ctx = document.getElementById('mainChart').getContext('2d');
      if (chart) chart.destroy();

      let dataValues = values.slice();
      if (normalize) {
        const s = dataValues.reduce((a,b)=>a+b,0) || 1;
        dataValues = dataValues.map(v => ((v/s)*100).toFixed(2));
      }

      chart = new Chart(ctx, {
        type: chartType,
        data: {
          labels: labels,
          datasets: [{
            label: 'Indicador',
            data: dataValues,
            // Chart.js picks defaults
          }]
        },
        options: {
          responsive: true,
          plugins: { legend: { position: 'bottom' }, tooltip: { mode: 'index' } },
          animation: { duration: 300 }
        }
      });
    }

    async function refreshAndRender() {
      const records = await fetchAllData();
      updateSummaries(records);

      const field = fieldSelect.value;
      const { labels, values } = buildCategoryCounts(records, field);
      const chartType = chartTypeSelect.value;
      const normalize = document.getElementById('normalize').checked;
      renderChart({labels, values}, chartType, normalize);
    }

    // iniciar
    (async function init(){
      // seleccionar indicador por defecto
      fieldSelect.value = INDICATORS[0].value;

      // cargar datos iniciales y render
      await refreshAndRender();

      // listeners UI
      fieldSelect.addEventListener('change', refreshAndRender);
      chartTypeSelect.addEventListener('change', refreshAndRender);
      document.getElementById('normalize').addEventListener('change', refreshAndRender);

      // suscripción en tiempo real a INSERT/UPDATE/DELETE
      const channel = supabase.channel('public:table-changes')
        .on('postgres_changes', { event: '*', schema: 'public', table: TABLE }, payload => {
          // console.log('Realtime payload', payload);
          refreshAndRender();
        })
        .subscribe();

      // seguridad: reconectar si la suscripción falla
      channel.on('subscription_state', (status) => console.log('Subscription state', status));
    })();

  </script>
</body>
</html>
