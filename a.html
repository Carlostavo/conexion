<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Dashboard Proambiental</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body {
      background-color: #f9fafb;
    }
  </style>
</head>

<body class="min-h-screen flex flex-col text-gray-800">
  <!-- HEADER -->
  <header class="bg-emerald-600 text-white py-4 shadow-md">
    <div class="max-w-7xl mx-auto px-4 flex justify-between items-center">
      <h1 class="text-2xl font-bold tracking-wide">ðŸŒ± Dashboard Proambiental</h1>
      <p class="text-sm opacity-90">Encuesta de comportamiento proambiental y autosustentabilidad</p>
    </div>
  </header>

  <!-- CONTENIDO PRINCIPAL -->
  <main class="flex-grow max-w-7xl mx-auto px-6 py-8">
    <div class="mb-6 grid md:grid-cols-4 gap-4">
      <div>
        <label class="block text-sm font-medium mb-1">Filtrar por sexo</label>
        <select id="filtroSexo" class="w-full border rounded-lg px-3 py-2">
          <option value="todos">Todos</option>
          <option value="masculino">Masculino</option>
          <option value="femenino">Femenino</option>
        </select>
      </div>

      <div>
        <label class="block text-sm font-medium mb-1">DimensiÃ³n</label>
        <select id="filtroDimension" class="w-full border rounded-lg px-3 py-2">
          <option value="conocimiento">Conocimiento</option>
          <option value="percepcion">PercepciÃ³n</option>
          <option value="actitud">Actitud</option>
          <option value="participacion">ParticipaciÃ³n</option>
          <option value="impacto">Impacto y oportunidades</option>
        </select>
      </div>

      <div>
        <label class="block text-sm font-medium mb-1">Tipo de grÃ¡fico</label>
        <select id="tipoGrafico" class="w-full border rounded-lg px-3 py-2">
          <option value="bar">Barras</option>
          <option value="pie">Pastel</option>
          <option value="radar">Radar</option>
        </select>
      </div>

      <div class="flex items-end">
        <button id="btnActualizar" class="bg-emerald-600 hover:bg-emerald-700 text-white px-4 py-2 rounded-lg w-full">Actualizar</button>
      </div>
    </div>

    <div id="loading" class="text-center text-gray-500 py-8">Cargando datos desde Supabase...</div>

    <section id="contenidoDashboard" class="hidden">
      <div class="grid md:grid-cols-2 gap-6 mb-8">
        <div class="bg-white rounded-xl shadow p-5">
          <h2 class="text-lg font-semibold mb-3">DistribuciÃ³n por Sexo</h2>
          <canvas id="graficoSexo"></canvas>
        </div>

        <div class="bg-white rounded-xl shadow p-5">
          <h2 class="text-lg font-semibold mb-3">Promedio de Edad</h2>
          <p id="promedioEdad" class="text-2xl font-bold text-emerald-700"></p>
        </div>
      </div>

      <div class="bg-white rounded-xl shadow p-5">
        <h2 id="tituloGrafico" class="text-lg font-semibold mb-3"></h2>
        <canvas id="graficoPrincipal"></canvas>
      </div>
    </section>
  </main>

  <footer class="bg-gray-100 text-center text-sm py-4 text-gray-500">
    Â© 2025 Proyecto Proambiental â€” Desarrollado con Supabase & Vercel
  </footer>

  <script>
    // --- CONFIGURACIÃ“N SUPABASE ---
    const supabaseUrl = "https://dutapywxsiuxboqsjqvf.supabase.co";
    const supabaseKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImR1dGFweXd4c2l1eGJvcXNqcXZmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTM3MTk1MTUsImV4cCI6MjA2OTI5NTUxNX0.SBIDeV_WAWlyLs-ROD1ibXtqqY5bbbh0gouY8gRB9Y4";
    const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);

    let chartPrincipal = null;
    let chartSexo = null;

    async function cargarDatos() {
      const { data, error } = await supabase
        .from("cuestionario_comportamiento_proambiental_autosustentabilidad")
        .select("*");

      if (error) {
        console.error(error);
        document.getElementById("loading").innerText = "Error al cargar los datos.";
        return [];
      }

      document.getElementById("loading").style.display = "none";
      document.getElementById("contenidoDashboard").classList.remove("hidden");
      return data;
    }

    function filtrarData(data, sexo) {
      if (sexo === "todos") return data;
      return data.filter(d => d.sexo?.toLowerCase() === sexo);
    }

    function contarLikert(respuestas) {
      const niveles = ["Totalmente en desacuerdo", "En desacuerdo", "Indiferente", "De acuerdo", "Totalmente de acuerdo"];
      return niveles.map(nivel =>
        respuestas.filter(r => r?.toLowerCase() === nivel.toLowerCase()).length
      );
    }

    function crearGrafico(canvasId, tipo, titulo, labels, dataValues, color = "#2a9d8f") {
      const ctx = document.getElementById(canvasId).getContext("2d");
      if (chartPrincipal && canvasId === "graficoPrincipal") chartPrincipal.destroy();
      if (chartSexo && canvasId === "graficoSexo") chartSexo.destroy();

      const nuevoChart = new Chart(ctx, {
        type: tipo,
        data: {
          labels,
          datasets: [
            {
              label: titulo,
              data: dataValues,
              backgroundColor: [
                "#2a9d8f","#e76f51","#457b9d","#f4a261","#8ab17d"
              ]
            }
          ]
        },
        options: {
          responsive: true,
          scales: tipo === "bar" ? { y: { beginAtZero: true } } : {}
        }
      });
      if (canvasId === "graficoPrincipal") chartPrincipal = nuevoChart;
      if (canvasId === "graficoSexo") chartSexo = nuevoChart;
    }

    function generarIndicadores(data, dimension, tipoGrafico) {
      // SEXO
      const sexos = data.map(d => d.sexo);
      const hombres = sexos.filter(s => s?.toLowerCase() === "masculino").length;
      const mujeres = sexos.filter(s => s?.toLowerCase() === "femenino").length;
      crearGrafico("graficoSexo", "pie", "DistribuciÃ³n por sexo", ["Masculino", "Femenino"], [hombres, mujeres]);

      // EDAD
      const edades = data.map(d => d.edad).filter(e => e != null);
      const promedio = (edades.reduce((a, b) => a + b, 0) / edades.length).toFixed(1);
      document.getElementById("promedioEdad").innerText = `${promedio} aÃ±os`;

      // DIMENSIONES
      let campos = [];
      if (dimension === "conocimiento")
        campos = ["conoce_desechos_solidos", "clasificacion_correcta_desechos", "beneficios_reutilizar_residuo"];
      else if (dimension === "percepcion")
        campos = ["desechos_solidos_problema_comunidad", "preocupa_exceso_desechos", "desechos_contaminan_ambiente"];
      else if (dimension === "actitud")
        campos = ["dedica_tiempo_reducir_reutilizar_reciclar", "falta_informacion_obstaculo_gestion", "reduccion_reciclaje_reutilizacion_cuida_ambiente"];
      else if (dimension === "participacion")
        campos = ["participaria_talleres_buenas_practicas", "dispuesto_participar_emprendimiento_desechos", "participaria_feria_emprendimientos_desechos"];
      else if (dimension === "impacto")
        campos = ["manejo_adecuado_desechos_aporta_desarrollo", "emprendimientos_reutilizacion_aportan_economia", "manejo_adecuado_desechos_impacto_ambiente"];

      const labels = ["Totalmente en desacuerdo", "En desacuerdo", "Indiferente", "De acuerdo", "Totalmente de acuerdo"];
      const valoresTotales = Array(5).fill(0);

      campos.forEach(campo => {
        const respuestas = data.map(d => d[campo]);
        const conteo = contarLikert(respuestas);
        for (let i = 0; i < valoresTotales.length; i++) {
          valoresTotales[i] += conteo[i];
        }
      });

      document.getElementById("tituloGrafico").innerText = `Indicadores: ${dimension.charAt(0).toUpperCase() + dimension.slice(1)}`;
      crearGrafico("graficoPrincipal", tipoGrafico, "Escala Likert", labels, valoresTotales);
    }

    async function iniciarDashboard() {
      const datos = await cargarDatos();

      const aplicarFiltros = () => {
        const sexo = document.getElementById("filtroSexo").value;
        const dimension = document.getElementById("filtroDimension").value;
        const tipoGrafico = document.getElementById("tipoGrafico").value;
        const filtrado = filtrarData(datos, sexo);
        generarIndicadores(filtrado, dimension, tipoGrafico);
      };

      document.getElementById("btnActualizar").addEventListener("click", aplicarFiltros);
      aplicarFiltros(); // carga inicial
    }

    iniciarDashboard();
  </script>
</body>
</html>
