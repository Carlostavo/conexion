<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Dashboard Supabase - Cuestionario Proambiental</title>

  <!-- Fuentes y librerías -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

  <style>
    :root {
      --bg:#0f1724; --card:#0b1220; --muted:#94a3b8; --accent:#06b6d4;
      font-family:'Inter',sans-serif;
    }
    body {
      margin:0; background:linear-gradient(180deg,#071426 0%, #081727 60%);
      color:#e6eef6; min-height:100vh;
    }
    header {
      display:flex; justify-content:space-between; align-items:center;
      padding:20px 28px; background:rgba(255,255,255,0.02); backdrop-filter:blur(6px);
      border-bottom:1px solid rgba(255,255,255,0.05);
    }
    .branding { display:flex; align-items:center; gap:10px; }
    .logo { background:linear-gradient(135deg,var(--accent),#60a5fa);
      color:#07203a; font-weight:700; border-radius:8px; width:44px; height:44px;
      display:flex; align-items:center; justify-content:center;
    }
    main { max-width:1200px; margin:20px auto; padding:24px; }
    .grid { display:grid; grid-template-columns:1fr 360px; gap:20px; }
    .card {
      background:var(--card); border-radius:12px; padding:18px;
      box-shadow:0 6px 18px rgba(2,6,23,0.6);
      border:1px solid rgba(255,255,255,0.05);
    }
    input, select, button {
      background:rgba(255,255,255,0.03); border:1px solid rgba(255,255,255,0.1);
      border-radius:8px; color:inherit; padding:8px 10px;
    }
    table { width:100%; border-collapse:collapse; font-size:13px; }
    th, td { padding:8px; border-bottom:1px solid rgba(255,255,255,0.05); text-align:left; }
    th { color:var(--muted); font-size:12px; text-transform:uppercase; }
    .controls { display:flex; gap:8px; margin-bottom:12px; flex-wrap:wrap; }
    .btn { cursor:pointer; }
    .loading { text-align:center; color:var(--muted); padding:20px; }
    @media(max-width:900px){ .grid{grid-template-columns:1fr;} }
  </style>
</head>
<body>
  <header>
    <div class="branding">
      <div class="logo">CP</div>
      <div>
        <h1 style="margin:0;font-size:18px;">Cuestionario Proambiental</h1>
        <p style="margin:0;font-size:13px;color:var(--muted);">
          Visualización de datos desde Supabase
        </p>
      </div>
    </div>
  </header>

  <main>
    <div class="grid">
      <section class="card">
        <div class="controls">
          <input id="search" placeholder="Buscar por nombre o encuestador">
          <select id="filterSexo">
            <option value="">Todos los sexos</option>
            <option value="Masculino">Masculino</option>
            <option value="Femenino">Femenino</option>
            <option value="Otro">Otro</option>
          </select>
          <button id="btnRefresh" class="btn">Actualizar</button>
          <button id="btnExport" class="btn">Exportar CSV</button>
        </div>

        <div id="tableWrap">
          <div id="loading" class="loading">Cargando datos...</div>
          <table id="dataTable" style="display:none;">
            <thead>
              <tr>
                <th>ID</th>
                <th>Fecha registro</th>
                <th>Encuestador</th>
                <th>Encuestado</th>
                <th>Sexo</th>
                <th>Edad</th>
              </tr>
            </thead>
            <tbody id="tbody"></tbody>
          </table>
        </div>
      </section>

      <aside class="card">
        <h3 style="margin-top:0;">Resumen</h3>
        <p style="font-size:13px;color:var(--muted);">Gráfico por sexo y estadísticas</p>
        <div style="height:200px;">
          <canvas id="sexoChart"></canvas>
        </div>
        <hr style="opacity:0.1;margin:12px 0;">
        <p>Total registros: <span id="total">0</span></p>
        <p>Edad promedio: <span id="avgEdad">—</span></p>
      </aside>
    </div>
  </main>

  <script>
    const SUPABASE_URL = "https://dutapywxsiuxboqsjqvf.supabase.co";
    const SUPABASE_ANON_KEY =
      "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImR1dGFweXd4c2l1eGJvcXNqcXZmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTM3MTk1MTUsImV4cCI6MjA2OTI5NTUxNX0.SBIDeV_WAWlyLs-ROD1ibXtqqY5bbbh0gouY8gRB9Y4";

    const { createClient } = supabase;
    const supabaseClient = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    const tableName = "cuestionario_comportamiento_proambiental_autosustentabilidad";

    const tbody = document.getElementById("tbody");
    const loading = document.getElementById("loading");
    const dataTable = document.getElementById("dataTable");
    const search = document.getElementById("search");
    const filterSexo = document.getElementById("filterSexo");
    const totalEl = document.getElementById("total");
    const avgEdadEl = document.getElementById("avgEdad");
    let allData = [];

    async function fetchData() {
      loading.style.display = "block";
      dataTable.style.display = "none";

      let query = supabaseClient.from(tableName).select("*").order("id", { ascending: false });
      if (filterSexo.value) query = query.eq("sexo", filterSexo.value);
      if (search.value.trim()) {
        const s = search.value.trim();
        query = query.or(`nombre_encuestado.ilike.%${s}%,nombre_encuestador.ilike.%${s}%`);
      }

      const { data, error } = await query;
      if (error) {
        loading.textContent = "Error al cargar: " + error.message;
        return;
      }

      allData = data;
      renderTable(data);
      renderCharts(data);
      loading.style.display = "none";
      dataTable.style.display = "table";
    }

    function renderTable(rows) {
      tbody.innerHTML = "";
      rows.forEach(r => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${r.id}</td>
          <td>${r.fecha_registro ? new Date(r.fecha_registro).toLocaleString("es-EC") : ""}</td>
          <td>${r.nombre_encuestador || ""}</td>
          <td>${r.nombre_encuestado || ""}</td>
          <td>${r.sexo || ""}</td>
          <td>${r.edad ?? ""}</td>`;
        tbody.appendChild(tr);
      });
    }

    function renderCharts(rows) {
      const total = rows.length;
      totalEl.textContent = total;

      const edades = rows.map(r => Number(r.edad)).filter(n => !isNaN(n));
      const avg = edades.length ? (edades.reduce((a, b) => a + b, 0) / edades.length).toFixed(1) : "—";
      avgEdadEl.textContent = avg;

      const counts = {};
      rows.forEach(r => {
        const s = r.sexo || "No declarado";
        counts[s] = (counts[s] || 0) + 1;
      });

      const labels = Object.keys(counts);
      const data = Object.values(counts);

      new Chart(document.getElementById("sexoChart"), {
        type: "doughnut",
        data: {
          labels,
          datasets: [{ data, backgroundColor: ["#3b82f6", "#f472b6", "#a3a3a3"] }]
        },
        options: { plugins: { legend: { position: "bottom" } } }
      });
    }

    document.getElementById("btnRefresh").addEventListener("click", fetchData);
    search.addEventListener("keyup", fetchData);
    filterSexo.addEventListener("change", fetchData);
    document.getElementById("btnExport").addEventListener("click", () => {
      if (!allData.length) return alert("No hay datos para exportar");
      const keys = Object.keys(allData[0]);
      const csv = [keys.join(",")].concat(allData.map(r => keys.map(k => `"${(r[k] ?? "").toString().replace(/"/g, '""')}"`).join(",")));
      const blob = new Blob([csv.join("\\n")], { type: "text/csv;charset=utf-8;" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "cuestionario.csv";
      document.body.appendChild(a);
      a.click();
      a.remove();
    });

    fetchData();
  </script>
</body>
</html>
